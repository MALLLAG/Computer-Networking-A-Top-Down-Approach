## 6.4 스위치 근거리 네트워크

<img width="728" height="506" alt="Image" src="https://github.com/user-attachments/assets/abf63769-0b5c-48bc-a403-1b36f518e4b1" />

이 섹션에서는 **스위치 근거리 네트워크(switched local area networks)** 에 대해 살펴봅니다.
그림 6.15는 세 개의 부서(전기공학, 컴퓨터공학, 시스템)가 있는 회사나 대학 캠퍼스에서의 스위치 LAN을 보여줍니다.

스위치 근거리 네트워크의 핵심 구성요소:
- **링크 계층 스위치**: 들어오는 링크 계층 프레임을 수신하고 나가는 링크로 전달
- **호스트와 라우터**: 각각 네트워크 어댑터를 통해 스위치에 연결

---

## 6.4.1 링크 계층 주소 지정과 ARP

### MAC 주소 (MAC Address)

호스트와 라우터에는 네트워크 계층 주소(IP 주소)가 있지만, 호스트와 라우터의 **어댑터(네트워크 인터페이스)** 에도 링크 계층 주소가 있습니다.
이를 **LAN 주소**, **물리 주소**, 또는 **MAC 주소**라고 부릅니다.

**MAC 주소의 특성**:
- 길이: **6바이트** (48비트), 2^48개의 가능한 MAC 주소 제공
- 일반적으로 16진수 표기법으로 표현 (예: 1A-23-F9-CD-06-9B)
- MAC 주소는 **영구적**이도록 설계됨 (ROM에 구워지거나 소프트웨어로 설정)
- **IEEE가 MAC 주소 공간을 관리**하여 두 어댑터가 같은 주소를 갖지 않도록 보장
- 어댑터 제조사가 IEEE에서 2^24 주소 청크를 구매

### MAC 주소 vs IP 주소

| MAC 주소 | IP 주소 |
|---------|--------|
| 평면적 구조 (계층 없음) | 계층적 구조 |
| 어댑터가 이동해도 동일 | 호스트가 이동하면 변경 |
| 주민등록번호와 유사 | 우편 주소와 유사 |

**왜 두 가지 주소가 모두 필요한가?**
- LAN은 IP뿐만 아니라 다양한 네트워크 계층 프로토콜(예: IPX, DECnet)을 위해 설계됨
- 어댑터의 RAM에 IP 주소를 저장해도, 어댑터가 네트워크 간에 이동될 때 재구성 필요
- 네트워크 계층 주소 없이 MAC 주소만 사용하면, ARP 테이블이 전 세계 모든 어댑터 항목을 가져야 함

### 브로드캐스트 주소

어댑터가 LAN의 모든 다른 어댑터가 프레임을 수신하고 처리하기를 원할 때, **MAC 브로드캐스트 주소** 사용:
- **FF-FF-FF-FF-FF-FF** (48개의 연속된 1)

### ARP (Address Resolution Protocol)

네트워크 계층 주소(IP)와 링크 계층 주소(MAC) 사이의 변환이 필요합니다.
인터넷에서 이 작업은 **주소 결정 프로토콜(ARP, Address Resolution Protocol)** 이 담당합니다.

**ARP 테이블**:
각 호스트와 라우터는 메모리에 ARP 테이블을 가지고 있습니다.
- IP 주소에서 MAC 주소로의 매핑 포함
- 각 항목에 **TTL(Time-To-Live)** 값 포함 (일반적으로 20분)
- 항목은 TTL 이후 삭제됨

**ARP 동작 과정** (동일 서브넷 내):

1. 송신자가 자신의 ARP 테이블에서 목적지 IP에 해당하는 MAC 주소 검색
2. 항목이 없으면, **ARP 쿼리 패킷**을 구성하여 **브로드캐스트 주소(FF-FF-FF-FF-FF-FF)** 로 전송
3. 서브넷의 모든 어댑터가 ARP 패킷을 수신
4. 쿼리된 IP 주소와 일치하는 어댑터가 **ARP 응답 패킷**으로 자신의 MAC 주소 회신
5. 송신자가 ARP 테이블을 업데이트하고 링크 계층 프레임 전송

**ARP의 특성**:
- ARP 쿼리는 **브로드캐스트 프레임**으로 전송, 응답은 **표준 프레임**으로 전송
- ARP는 **플러그 앤 플레이** - 시스템 관리자 구성 불필요
- 호스트가 서브넷에서 연결 해제되면 해당 항목은 다른 ARP 테이블에서 자동 삭제

**ARP는 링크 계층 프로토콜인가, 네트워크 계층 프로토콜인가?**
- ARP 패킷은 링크 계층 프레임 내에 캡슐화됨 → 링크 계층 프로토콜
- 링크 계층 주소와 네트워크 계층 주소를 모두 포함 → 네트워크 계층 프로토콜
- **결론**: ARP는 링크 계층과 네트워크 계층의 **경계에 걸쳐 있는 프로토콜**

### 서브넷 외부로 데이터그램 전송

호스트가 **다른 서브넷**의 호스트로 데이터그램을 보내려면:

1. 송신 호스트가 데이터그램을 어댑터에 전달
2. **목적지 MAC 주소**: 최종 목적지가 아닌 **첫 번째 홉 라우터 인터페이스**의 MAC 주소 사용
3. 라우터가 프레임을 수신하고 네트워크 계층으로 전달
4. 라우터가 포워딩 테이블을 참조하여 올바른 인터페이스로 데이터그램 전달
5. 라우터가 ARP를 사용하여 **최종 목적지의 MAC 주소** 획득
6. 새 프레임으로 데이터그램을 캡슐화하여 목적지 서브넷으로 전송

**중요**: 송신 호스트가 직접 최종 목적지의 MAC 주소를 사용하면 안 됨!
- 해당 MAC 주소는 송신 서브넷의 어떤 어댑터와도 일치하지 않음
- 프레임은 단순히 "사라짐" (데이터그램 천국으로...)

ARP는 RFC 826에 정의되어 있습니다.

---

## 6.4.2 이더넷 (Ethernet)

이더넷은 유선 LAN 시장을 사실상 장악했습니다.
1970년대 중반 발명 이래로 계속 진화하며 지배적 위치를 유지해왔습니다.

> "이더넷이 근거리 네트워킹에 있어서 인터넷이 글로벌 네트워킹에 있는 것과 같다."

### 이더넷 성공의 이유

1. **선점 효과**: 최초로 널리 배포된 고속 LAN
2. **기존 기술 대비 단순성과 저비용**: 토큰 링, FDDI, ATM보다 간단하고 저렴
3. **지속적인 속도 향상**: 다른 기술이 등장할 때마다 더 빠른 버전 출시
4. **규모의 경제**: 하드웨어(어댑터, 스위치)가 매우 저렴해짐

### 이더넷의 진화

| 시기 | 토폴로지 | 특징 |
|-----|---------|-----|
| 1970년대 중반 | 동축 버스 | Bob Metcalfe와 David Boggs가 발명, 2.94 Mbps |
| 1980년대~1990년대 중반 | 버스/허브 기반 스타 | 브로드캐스트 LAN, 충돌 발생 |
| 1990년대 후반 | 허브 기반 스타 | 10 Mbps 표준화 |
| 2000년대 초반 | **스위치 기반 스타** | 충돌 없음, 저장 후 전달 |
| 현재 | 스위치 기반 스타 | 10/100/1000 Mbps, 10/40 Gbps |

### 허브 vs 스위치

**허브(Hub)**:
- 물리 계층 장치로 개별 **비트**에 대해 동작
- 한 인터페이스에서 비트를 받으면 모든 다른 인터페이스로 재전송
- 브로드캐스트 LAN → 충돌 발생 가능

**스위치(Switch)**:
- "충돌 없음" + 저장 후 전달 패킷 스위치
- 라우터와 달리 **계층 2**까지만 동작
- 각 인터페이스가 **전이중(full-duplex)** 으로 동작

### 이더넷 프레임 구조

```
| Preamble | Dest. address | Source address | Type | Data | CRC |
|  8바이트  |    6바이트     |     6바이트     | 2바이트| 46-1500바이트 | 4바이트 |
```

**각 필드 설명**:

- **프리앰블 (Preamble, 8바이트)**:
  - 처음 7바이트: 각각 10101010 값
  - 마지막 바이트: 10101011
  - 수신 어댑터의 클럭을 송신자 클럭에 동기화하는 역할
  - 마지막 2비트(11)가 "중요한 내용이 시작됨"을 알림

- **목적지 주소 (6바이트)**: 수신 어댑터의 MAC 주소
  - 자신의 MAC 주소 또는 브로드캐스트 주소와 일치하면 네트워크 계층으로 전달
  - 그렇지 않으면 프레임 폐기

- **출발지 주소 (6바이트)**: 송신 어댑터의 MAC 주소

- **타입 필드 (2바이트)**: 네트워크 계층 프로토콜 식별
  - IP: 특정 타입 번호
  - ARP: 0x0806
  - 역다중화(demultiplexing) 역할 (IP 데이터그램의 프로토콜 필드와 유사)

- **데이터 필드 (46~1,500바이트)**: IP 데이터그램 포함
  - **MTU(Maximum Transmission Unit)**: 1,500바이트
  - 1,500바이트 초과 시 단편화 필요
  - 46바이트 미만 시 **스터핑(stuffing)** 으로 채움

- **CRC (4바이트)**: 순환 중복 검사
  - 수신 어댑터가 비트 오류 검출
  - CRC 검사 실패 시 프레임 폐기

### 이더넷의 서비스 특성

**비연결 서비스 (Connectionless)**:
- 어댑터 A가 어댑터 B에게 데이터그램을 보낼 때 핸드셰이킹 없음
- IP의 계층 3 데이터그램 서비스, UDP의 계층 4 비연결 서비스와 유사

**비신뢰적 서비스 (Unreliable)**:
- CRC 검사 통과 시에도 확인응답 없음
- CRC 검사 실패 시에도 부정 확인응답 없음
- 프레임 단순히 폐기 → 네트워크 계층에 갭 발생 가능
- TCP 사용 시 재전송으로 복구, UDP 사용 시 데이터 손실

### 이더넷 기술 표준

이더넷 기술은 IEEE 802.3 CSMA/CD (이더넷) 작업 그룹에 의해 표준화되었습니다.

**명명 규칙** (예: 100BASE-T):
- **첫 번째 부분**: 속도 (10, 100, 1000, 10G, 40G)
- **BASE**: 베이스밴드 이더넷
- **마지막 부분**: 물리 매체 (T = 연선, F/FX/SX/BX = 광섬유)

**100 Mbps 이더넷 (Fast Ethernet)**:
- 100BASE-TX, 100BASE-T2, 100BASE-T4 (구리)
- 100BASE-FX, 100BASE-SX, 100BASE-BX (광섬유)
- 연선으로 100미터, 광섬유로 수 킬로미터까지

**기가비트 이더넷 (IEEE 802.3z)**:
- 40,000 Mbps (40 Gbps) 데이터 전송률
- 기존 이더넷 장비와 완전 호환
- 표준 이더넷 프레임 형식 사용
- 점대점 링크와 공유 브로드캐스트 채널 모두 지원
- 점대점 채널에서 양방향 40 Gbps 전이중 동작
- 카테고리 5 UTP 케이블링으로 실행 가능 (1000BASE-T, 10GBASE-T)

**오늘날의 이더넷**: 스위치 기반 스타 토폴로지에서는 충돌이 없으므로 **MAC 프로토콜이 불필요**!
- 그러나 이더넷 프레임 형식은 30년 이상 변함없이 유지됨
- 이것이 이더넷 표준의 핵심적이고 영원한 중심

---

## 6.4.3 링크 계층 스위치

스위치의 역할은 들어오는 링크 계층 프레임을 수신하고 나가는 링크로 전달하는 것입니다.

**스위치의 특성**:
- 서브넷의 호스트와 라우터에게 **투명(transparent)**
- 호스트/라우터는 프레임을 다른 호스트/라우터에게 주소 지정 (스위치에게가 아님)
- 스위치가 프레임을 수신하고 전달하는 것을 인식하지 못함
- 프레임 도착률이 출력 인터페이스 용량을 초과할 수 있으므로 **출력 버퍼** 보유

### 필터링과 전달

**필터링(Filtering)**: 프레임을 특정 인터페이스로 전달할지 또는 폐기할지 결정하는 기능

**전달(Forwarding)**: 프레임이 전달되어야 할 인터페이스를 결정하고 해당 인터페이스로 이동시키는 기능

이 두 기능은 **스위치 테이블**을 사용하여 수행됩니다.

**스위치 테이블 항목**:
| 주소 | 인터페이스 | 시간 |
|-----|-----------|-----|
| 62-FE-F7-11-89-A3 | 1 | 9:32 |
| 7C-BA-B2-B4-91-10 | 3 | 9:36 |

**스위치 동작 (목적지 주소 DD-DD-DD-DD-DD-DD로 인터페이스 x에서 프레임 도착 시)**:

1. **테이블에 항목 없음**: 프레임을 인터페이스 x를 **제외한 모든 인터페이스**의 출력 버퍼로 전달 (브로드캐스트)

2. **테이블에 항목 있음, 인터페이스 x와 연관**: 프레임이 이미 목적지가 있는 LAN 세그먼트에서 왔으므로 프레임 **폐기** (필터링)

3. **테이블에 항목 있음, 인터페이스 y(≠x)와 연관**: 프레임을 인터페이스 y에 연결된 LAN 세그먼트로 **전달**

### 자가 학습 (Self-Learning)

스위치는 **플러그 앤 플레이 장치**입니다.
네트워크 관리자나 구성 프로토콜의 개입 없이 테이블이 **자동으로, 동적으로, 자율적으로** 구축됩니다.

**자가 학습 과정**:

1. 스위치 테이블이 초기에 **비어 있음**

2. 각 인터페이스에서 수신된 프레임에 대해 스위치가 테이블에 저장:
   - 프레임의 **출발지 주소 필드**에 있는 MAC 주소
   - 프레임이 **도착한 인터페이스**
   - **현재 시간**
   - 이 방식으로 LAN의 모든 호스트가 결국 테이블에 기록됨

3. **에이징 타임(aging time)** 후에 해당 주소를 출발지 주소로 하는 프레임이 수신되지 않으면 스위치가 테이블에서 해당 주소 삭제
   - PC가 다른 PC(다른 어댑터)로 교체되면 원래 PC의 MAC 주소가 자동으로 테이블에서 제거됨

### 링크 계층 스위칭의 특성

버스나 허브 기반 스타 토폴로지와 같은 브로드캐스트 링크 대신 스위치 사용의 장점:

1. **충돌 제거**: 스위치로 구축된 LAN(허브 없음)에서는 충돌로 인한 대역폭 낭비가 없음
   - 스위치가 프레임을 버퍼링하고 한 세그먼트에 동시에 둘 이상의 프레임을 전송하지 않음
   - 스위치의 최대 총 처리량은 모든 스위치 인터페이스 속도의 합

2. **이종 링크**: 스위치가 링크를 서로 격리하므로 LAN의 다른 링크들이 다른 속도와 다른 매체에서 동작 가능
   - 예: 1 Gbps 1000BASE-T 구리 링크 + 100 Mbps 100BASE-FX 광섬유 링크 + 100BASE-T 구리 링크 혼합
   - 레거시 장비와 새 장비를 혼합하기에 이상적

3. **관리**: 향상된 보안과 네트워크 관리 용이
   - 오작동 어댑터(재버링 어댑터) 감지 및 내부적으로 연결 해제
   - 대역폭 사용량, 충돌률, 트래픽 유형에 대한 통계 수집
   - 이 정보로 문제 디버그, 수정, LAN 진화 계획 수립

### 스위치 vs 라우터

| 특성 | 스위치 | 라우터 |
|-----|-------|-------|
| 패킷 스위치 유형 | 저장 후 전달 | 저장 후 전달 |
| 전달 기준 | MAC 주소 (계층 2) | IP 주소 (계층 3) |
| 처리 계층 | 계층 2까지 | 계층 3까지 |
| 트래픽 격리 | Yes | Yes |
| 플러그 앤 플레이 | Yes | No |
| 최적 라우팅 | No (스패닝 트리) | Yes |

**스위치의 장단점**:
- 장점: 플러그 앤 플레이, 높은 필터링/전달 속도 (계층 2까지만 처리)
- 단점: 브로드캐스트 프레임 순환 방지를 위해 **스패닝 트리**로 토폴로지 제한, 대규모 네트워크에서 큰 ARP 테이블과 상당한 ARP 트래픽, **브로드캐스트 스톰**에 취약

**라우터의 장단점**:
- 장점: 계층적 주소 지정으로 중복 경로에서도 패킷 순환 없음 (IP의 TTL 필드), 스패닝 트리 제한 없이 최적 경로 사용, 브로드캐스트 스톰에 대한 방화벽 보호 제공
- 단점: 플러그 앤 플레이가 아님 (IP 주소 구성 필요), 계층 3까지 처리해야 하므로 패킷당 처리 시간이 더 김

**권장 사항**:
- **소규모 네트워크** (수백 호스트, 몇 개의 LAN 세그먼트): 스위치로 충분
  - 트래픽 지역화, IP 주소 구성 없이 총 처리량 증가
- **대규모 네트워크** (수천 호스트): 스위치와 라우터 함께 사용
  - 라우터가 더 강력한 트래픽 격리, 브로드캐스트 스톰 제어, 더 "지능적인" 라우트 제공

---

## 6.4.4 가상 근거리 네트워크 (VLANs)

그림 6.15와 같은 계층적 LAN 구성의 세 가지 문제점:

1. **트래픽 격리 부족**: 계층 구조가 그룹 트래픽을 단일 스위치 내로 지역화하지만, 브로드캐스트 트래픽(ARP, DHCP 등)은 여전히 전체 기관 네트워크를 통과해야 함
   - 보안/프라이버시를 위해 LAN 브로드캐스트 트래픽 제한이 필요할 수 있음

2. **스위치의 비효율적 사용**: 3개 그룹 대신 10개 그룹이 있다면 10개의 1차 스위치 필요
   - 각 그룹이 10명 미만이면 단일 96포트 스위치로 충분하지만 트래픽 격리 제공 안 됨

3. **사용자 관리**: 직원이 그룹 간 이동 시 물리적 케이블링 변경 필요
   - 두 그룹에 속한 직원은 문제가 더 복잡해짐

### VLAN의 개념

**가상 근거리 네트워크(VLAN, Virtual Local Area Network)** 는 이러한 어려움을 해결합니다.

VLAN을 지원하는 스위치는 단일 **물리적** 근거리 네트워크 인프라 위에 여러 **가상** 근거리 네트워크를 정의할 수 있습니다.

**포트 기반 VLAN**에서:
- 스위치의 포트(인터페이스)가 네트워크 관리자에 의해 그룹으로 분할
- 각 그룹이 하나의 VLAN을 구성하며 **브로드캐스트 도메인** 형성
- 한 포트의 브로드캐스트 트래픽은 해당 그룹의 다른 포트에만 도달

<img width="543" height="321" alt="Image" src="https://github.com/user-attachments/assets/3b911a5b-c4f2-4dc8-9b2d-cc7833a07ea5" />

**예시** (그림 6.25):
- 16포트 스위치
- 포트 2~8: EE VLAN (전기공학)
- 포트 9~15: CS VLAN (컴퓨터과학)
- 포트 1, 16: 미할당

**VLAN의 장점**:
- EE와 CS VLAN 프레임이 서로 격리됨
- 두 개의 스위치가 하나로 대체됨
- 사용자 이동 시 포트의 VLAN 소속만 재구성하면 됨

### VLAN 간 통신

두 VLAN을 완전히 격리하면 새로운 문제 발생: EE 부서에서 CS 부서로 트래픽을 어떻게 보낼까?

**해결책 1**: VLAN 스위치 포트(예: 포트 1)를 외부 라우터에 연결하고 해당 포트가 EE와 CS VLAN 모두에 속하도록 구성
- EE에서 CS로 가는 IP 데이터그램은 EE VLAN을 거쳐 라우터에 도달한 후 CS VLAN을 통해 CS 호스트에 도달

**해결책 2**: 스위치 벤더가 VLAN 스위치 **와** 라우터를 포함하는 단일 장치 제공
- 별도의 외부 라우터 불필요

### VLAN 트렁킹 (VLAN Trunking)

서로 다른 건물에 있는 EE와 CS 교수진이 자신의 부서 VLAN에 속하려면?

<img width="799" height="558" alt="Image" src="https://github.com/user-attachments/assets/84fea408-0273-44ee-bd7c-ff2c1e9ef731" />

**비확장적 해결책** (그림 6.26a):
- 각 VLAN에 대해 각 스위치의 포트 하나씩을 정의하고 연결
- N개의 VLAN이면 두 스위치를 연결하는 데 N개의 포트 필요 → 확장성 없음

**확장적 해결책 - VLAN 트렁킹** (그림 6.26b):
- 각 스위치의 특수 포트(트렁크 포트)가 두 VLAN 스위치를 상호 연결
- 트렁크 포트는 **모든 VLAN에 속함**
- 어떤 VLAN으로 전송된 프레임도 트렁크 링크를 통해 다른 스위치로 전달됨

**802.1Q 프레임**:
트렁크 포트로 도착하는 프레임이 어떤 VLAN에 속하는지 어떻게 알 수 있을까?

IEEE는 VLAN 트렁크를 통과하는 프레임을 위한 확장 이더넷 프레임 형식 **802.1Q**를 정의했습니다.

**VLAN 태그 (4바이트)**:
- **태그 프로토콜 식별자(TPID)** (2바이트): 고정 16진수 값 81-00
- **태그 제어 정보(TCI)** (2바이트):
  - 12비트 VLAN 식별자 필드
  - 3비트 우선순위 필드 (IP 데이터그램의 TOS 필드와 유사)

VLAN 태그는:
- 송신 측 스위치에서 VLAN 트렁크로 진입하는 프레임에 **추가**
- 수신 측 스위치에서 **파싱 후 제거**

### VLAN 정의 방식

포트 기반 VLAN 외에도 여러 방식으로 VLAN 정의 가능:

- **MAC 기반 VLAN**: 네트워크 관리자가 각 VLAN에 속하는 MAC 주소 집합 지정. 장치가 포트에 연결되면 MAC 주소 기반으로 적절한 VLAN에 연결
- **네트워크 계층 프로토콜 기반 VLAN**: IPv4, IPv6, Appletalk 등 기준
- **IP 라우터를 통한 VLAN 확장**: LAN의 섬들을 연결하여 전 세계를 아우르는 단일 VLAN 형성 가능

자세한 내용은 802.1Q 표준 [IEEE 802.1q 2005]을 참조하세요.
