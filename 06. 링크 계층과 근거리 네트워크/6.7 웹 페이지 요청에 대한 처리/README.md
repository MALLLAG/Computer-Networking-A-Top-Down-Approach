# 6.7 회고: 웹 페이지 요청의 하루

## 개요

링크 계층, 네트워크 계층, 전송 계층, 애플리케이션 계층을 모두 다루었으므로, 프로토콜 스택 전체를 통합적으로 살펴본다. 가장 단순한 요청인 **웹 페이지 다운로드**에 관련된 많은 프로토콜을 식별하여 "큰 그림"을 조망한다.

### 시나리오 설정

- **사용자**: Bob (학생)
- **행동**: 노트북을 학교 이더넷 스위치에 연결하고 www.google.com 홈페이지 다운로드
- **네트워크 구성**:
  - 학교 네트워크: 68.80.2.0/24
  - Comcast 네트워크: 68.80.0.0/13
  - Google 네트워크: 64.233.160.0/19
  - DNS 서버: comcast.net (68.87.71.226)
  - 웹 서버: www.google.com (64.233.169.105)

<img width="620" height="458" alt="Image" src="https://github.com/user-attachments/assets/1323ff7c-91fc-44a3-a279-435cd8afa5f8" />

---

## 6.7.1 시작하기: DHCP, UDP, IP, 이더넷

Bob이 노트북을 부팅하고 학교의 이더넷 스위치에 연결하면, 가장 먼저 **IP 주소를 얻기 위해 DHCP 프로토콜**을 실행한다.

### 단계 1: DHCP 요청 메시지 생성

| 계층 | 동작 |
|------|------|
| **애플리케이션** | DHCP 요청 메시지 생성 |
| **전송** | UDP 세그먼트에 캡슐화 (목적지 포트 67, 출발지 포트 68) |
| **네트워크** | IP 데이터그램에 캡슐화 (목적지 IP: 255.255.255.255, 출발지 IP: 0.0.0.0) |
| **링크** | 이더넷 프레임에 캡슐화 (목적지 MAC: FF:FF:FF:FF:FF:FF, 출발지 MAC: 00:16:D3:23:68:8A) |

### 단계 2: 이더넷 프레임 전송

- 이더넷 프레임의 목적지 MAC 주소가 FF:FF:FF:FF:FF:FF (브로드캐스트)
- 스위치에 연결된 모든 장치로 브로드캐스트 (DHCP 서버 포함)

### 단계 3: 브로드캐스트 프레임 전달

- 스위치가 DHCP 요청을 포함한 수신 프레임을 모든 출력 포트로 브로드캐스트
- 라우터에 연결된 포트 포함

### 단계 4: 라우터에서 DHCP 요청 수신

| 처리 단계 | 설명 |
|----------|------|
| **프레임 수신** | MAC 주소 00:22:6B:45:1F:1B 인터페이스에서 수신 |
| **IP 추출** | 이더넷 프레임에서 IP 데이터그램 추출 |
| **역다중화** | 브로드캐스트 IP 목적지 주소로 인해 상위 계층으로 전달 |
| **UDP 추출** | 데이터그램 페이로드(UDP 세그먼트)에서 DHCP 요청 메시지 추출 |

### 단계 5: DHCP 서버 응답

DHCP 서버(라우터 내에서 실행)가 CIDR 블록 68.85.2.0/24에서 IP 주소를 할당한다.

**DHCP ACK 메시지 내용**:
| 정보 | 값 |
|------|---|
| **할당된 IP 주소** | 68.85.2.101 |
| **DNS 서버 IP** | 68.87.71.226 |
| **기본 게이트웨이 IP** | 68.85.2.1 |
| **서브넷 블록** | 68.85.2.0/24 |

**캡슐화**:
- DHCP 메시지 → UDP 세그먼트 → IP 데이터그램 → 이더넷 프레임
- 출발지 MAC: 00:22:6B:45:1F:1B (라우터)
- 목적지 MAC: 00:16:D3:23:68:8A (Bob의 노트북)

### 단계 6: DHCP ACK 전송

- 라우터가 DHCP ACK를 포함한 이더넷 프레임을 스위치로 전송 (유니캐스트)
- 스위치는 **자기 학습(self-learning)**으로 Bob의 노트북 MAC 주소를 학습했으므로 해당 포트로만 전달

### 단계 7: Bob의 노트북에서 DHCP ACK 수신

| 처리 | 설명 |
|------|------|
| **프레임 수신** | 이더넷 프레임에서 IP 데이터그램 추출 |
| **세그먼트 추출** | IP 데이터그램에서 UDP 세그먼트 추출 |
| **메시지 추출** | UDP 세그먼트에서 DHCP ACK 메시지 추출 |
| **정보 기록** | IP 주소, DNS 서버 주소 기록 |
| **포워딩 테이블 설정** | 기본 게이트웨이 주소를 IP 포워딩 테이블에 설치 |

> 이 시점에서 Bob의 노트북은 네트워킹 구성 요소를 초기화했으며 웹 페이지 가져오기를 시작할 준비가 되었다.

---

## 6.7.2 계속 시작하기: DNS와 ARP

Bob이 웹 브라우저에 www.google.com URL을 입력하면, HTTP 요청을 보내기 위한 **TCP 소켓**을 생성해야 한다. 이를 위해 www.google.com의 **IP 주소**가 필요하다.

### 단계 8: DNS 쿼리 메시지 생성

| 계층 | 동작 |
|------|------|
| **애플리케이션** | DNS 쿼리 메시지 생성 ("www.google.com"을 질문 섹션에 포함) |
| **전송** | UDP 세그먼트에 캡슐화 (목적지 포트 53) |
| **네트워크** | IP 데이터그램에 캡슐화 (목적지 IP: 68.87.71.226, 출발지 IP: 68.85.2.101) |

### 단계 9: 이더넷 프레임 주소 지정 문제

- DNS 쿼리를 포함한 데이터그램을 이더넷 프레임에 넣어야 함
- 링크 계층에서 게이트웨이 라우터(68.85.2.1)로 전송해야 함
- **문제**: Bob의 노트북은 게이트웨이 라우터의 IP 주소는 알지만 **MAC 주소를 모름**
- **해결**: **ARP 프로토콜** 사용

### 단계 10: ARP 쿼리 생성

| 필드 | 값 |
|------|---|
| **대상 IP 주소** | 68.85.2.1 (기본 게이트웨이) |
| **프레임 목적지 MAC** | FF:FF:FF:FF:FF:FF (브로드캐스트) |

- ARP 쿼리 메시지를 이더넷 프레임에 넣어 스위치로 전송
- 스위치가 연결된 모든 장치(게이트웨이 라우터 포함)에 프레임 전달

### 단계 11: 게이트웨이 라우터의 ARP 응답

- 라우터가 학교 네트워크 인터페이스에서 ARP 쿼리 메시지를 포함한 프레임 수신
- ARP 메시지의 대상 IP 주소 68.85.2.1이 자신의 인터페이스 IP와 일치
- **ARP 응답** 준비: MAC 주소 00:22:6B:45:1F:1B가 IP 주소 68.85.2.1에 대응함을 알림
- 목적지 MAC 00:16:D3:23:68:8A (Bob의 노트북)로 이더넷 프레임 전송

### 단계 12: Bob의 노트북에서 ARP 응답 수신

- ARP 응답 메시지를 포함한 프레임 수신
- 게이트웨이 라우터의 MAC 주소 (00:22:6B:45:1F:1B) 추출

### 단계 13: DNS 쿼리 프레임 전송

이제 Bob의 노트북은 게이트웨이 라우터의 MAC 주소를 알게 되어 DNS 쿼리를 포함한 이더넷 프레임을 주소 지정할 수 있다.

| 필드 | 값 |
|------|---|
| **IP 목적지 주소** | 68.87.71.226 (DNS 서버) |
| **프레임 목적지 MAC** | 00:22:6B:45:1F:1B (게이트웨이 라우터) |

- 스위치로 프레임 전송 → 게이트웨이 라우터로 전달

---

## 6.7.3 계속 시작하기: DNS 서버로의 도메인 내 라우팅

### 단계 14: 게이트웨이 라우터에서 DNS 쿼리 수신

- 프레임 수신 및 DNS 쿼리를 포함한 IP 데이터그램 추출
- 목적지 주소 68.87.71.226 조회
- 포워딩 테이블에서 Comcast 네트워크의 가장 왼쪽 라우터로 전송해야 함을 확인
- 해당 링크에 적합한 링크 계층 프레임에 IP 데이터그램을 넣어 전송

### 단계 15: Comcast 네트워크 내 라우팅

- Comcast 네트워크의 가장 왼쪽 라우터가 프레임 수신
- IP 데이터그램 추출 및 목적지 주소 68.87.71.226 검사
- 포워딩 테이블에서 DNS 서버로의 출력 인터페이스 결정
- **포워딩 테이블 구성**: Comcast의 도메인 내 프로토콜(RIP, OSPF, IS-IS) 및 인터넷의 도메인 간 프로토콜(BGP)에 의해 채워짐

### 단계 16: DNS 서버에서 쿼리 수신

- DNS 쿼리를 포함한 IP 데이터그램이 DNS 서버에 도착
- DNS 서버가 쿼리 메시지 추출
- DNS 데이터베이스에서 www.google.com 검색
- **DNS 리소스 레코드** 찾음: www.google.com의 IP 주소 64.233.169.105 (google.com의 권한 있는 DNS 서버에서 캐시됨)
- **DNS 응답 메시지** 생성: 호스트명-IP 주소 매핑 포함
- UDP 세그먼트 → IP 데이터그램 (목적지: 68.85.2.101)
- Comcast 네트워크 → 학교 라우터 → 이더넷 스위치 → Bob의 노트북으로 전달

### 단계 17: Bob의 노트북에서 DNS 응답 수신

- DNS 메시지에서 www.google.com 서버의 IP 주소 추출
- **드디어** Bob의 노트북이 www.google.com 서버에 연결할 준비 완료!

---

## 6.7.4 웹 클라이언트-서버 상호작용: TCP와 HTTP

### 단계 18: TCP SYN 세그먼트 생성

이제 Bob의 노트북이 www.google.com의 IP 주소를 알게 되어 HTTP GET 메시지를 보내기 위한 **TCP 소켓**을 생성할 수 있다.

TCP 소켓 생성 시, Bob의 노트북의 TCP는 www.google.com의 TCP와 **3방향 핸드셰이크**를 수행해야 한다.

| 필드 | 값 |
|------|---|
| **TCP 세그먼트** | SYN 세그먼트 (목적지 포트 80) |
| **IP 목적지 주소** | 64.233.169.105 (www.google.com) |
| **프레임 목적지 MAC** | 00:22:6B:45:1F:1B (게이트웨이 라우터) |

### 단계 19: TCP SYN 라우팅

- 학교 네트워크, Comcast 네트워크, Google 네트워크의 라우터들이 TCP SYN을 포함한 데이터그램을 www.google.com으로 전달
- 각 라우터의 포워딩 테이블 사용
- Comcast와 Google 네트워크 간 도메인 간 링크의 포워딩 테이블 항목은 **BGP 프로토콜**에 의해 결정

### 단계 20: www.google.com에서 TCP SYN 수신

- TCP SYN 메시지가 데이터그램에서 추출되어 포트 80에 연결된 환영 소켓으로 역다중화
- Google HTTP 서버와 Bob의 노트북 간 TCP 연결을 위한 **연결 소켓** 생성
- **TCP SYNACK 세그먼트** 생성
- Bob의 노트북으로 주소 지정된 데이터그램에 넣어 www.google.com의 첫 번째 홉 라우터로 전송

### 단계 21: Bob의 노트북에서 TCP SYNACK 수신

- TCP SYNACK을 포함한 데이터그램이 Google, Comcast, 학교 네트워크를 통해 전달
- Bob의 노트북의 이더넷 컨트롤러에 도착
- 단계 18에서 생성한 TCP 소켓으로 역다중화
- **연결 상태(connected state)** 진입

### 단계 22: HTTP GET 요청 전송

- 소켓이 바이트 전송 준비 완료
- Bob의 브라우저가 **HTTP GET 메시지** 생성 (가져올 URL 포함)
- HTTP GET 메시지를 소켓에 기록
- GET 메시지가 TCP 세그먼트의 페이로드가 됨
- TCP 세그먼트 → 데이터그램 → www.google.com으로 전송 (단계 18-20과 동일 경로)

### 단계 23: www.google.com에서 HTTP GET 처리

- HTTP 서버가 TCP 소켓에서 HTTP GET 메시지 읽음
- **HTTP 응답 메시지** 생성
- 요청된 웹 페이지 콘텐츠를 HTTP 응답 메시지 본문에 포함
- TCP 소켓으로 메시지 전송

### 단계 24: Bob의 노트북에서 HTTP 응답 수신

- HTTP 응답 메시지를 포함한 데이터그램이 Google, Comcast, 학교 네트워크를 통해 Bob의 노트북에 도착
- 웹 브라우저 프로그램이 소켓에서 HTTP 응답 읽음
- HTTP 응답 본문에서 웹 페이지의 HTML 추출
- **드디어** 웹 페이지 표시!

---

## 요약

위 시나리오에서 많은 네트워킹 기반을 다루었다. 예제가 상세해 보이지만, 다음과 같은 추가 프로토콜들은 생략되었다:

| 생략된 프로토콜/기술 | 설명 |
|---------------------|------|
| **NAT** | 학교 게이트웨이 라우터에서 실행 |
| **무선 접속** | 학교 네트워크에 대한 무선 접속 |
| **보안 프로토콜** | 세그먼트나 데이터그램 암호화 |
| **네트워크 관리 프로토콜** | 네트워크 관리 |
| **웹 캐싱** | DNS 계층 구조 |

> 이 예제는 "어떻게(how)"에 더 초점을 맞추었다. 네트워크 프로토콜 설계에 대한 "왜(why)"에 대한 더 넓고 반영적인 관점을 위해서는 4.5절 "인터넷의 아키텍처 원칙"을 다시 읽어보기를 권장한다.
