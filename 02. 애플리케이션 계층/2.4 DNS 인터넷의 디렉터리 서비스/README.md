## 2.4 DNS — 인터넷의 디렉터리 서비스

우리는 사람을 식별할 때 여러 가지 방법을 사용할 수 있습니다. 예를 들어, 출생증명서에 적힌 이름, 주민등록번호, 운전면허증 번호 등이 있습니다. <br>
이들 방법은 모두 신원을 확인하는 데 쓸 수 있지만, 상황에 따라 어떤 방법이 더 적합할 수 있습니다. 예를 들어, 미국 국세청 컴퓨터가 신원을 확인할 때는 주민등록번호가 출생증명서 이름보다 더 유용할 것입니다. <br>
반면, 일반인들끼리 대화할 때는 기억하기 쉬운 이름을 선호합니다. (실제로 “안녕, 나는 S282866026이고, 이 사람은 내 남편 E132643678이야.”라고 말하는 걸 상상해보세요.)

이처럼 사람을 여러 방식으로 식별할 수 있듯이, 컴퓨터도 여러 방식으로 호스트를 식별합니다. 그 중 하나가 호스트 이름(hostname)입니다. <br>
예를 들어 www.facebook.com, www.google.com, gaia.cs.umass.edu 등이 있습니다. 호스트 이름은 기억하기 쉽기 때문에 사람들이 주로 사용합니다. <br>
하지만 호스트 이름만으로 해당 호스트가 인터넷의 어디에 위치하는지 많은 정보를 알 수는 없습니다. (예: www.eurecom.fr의 경우 .fr로 끝나서 프랑스에 있다는 것 정도만 알 수 있습니다.) <br>
또한, 호스트 이름은 길이가 일정하지 않은 영숫자 문자열로 이루어져 있어 라우터가 처리하기 어렵습니다. 이런 이유로 IP 주소(IP address)라는 또 다른 식별 방법이 있습니다.

IP 주소는 4개의 바이트로 구성되며, 고정된 계층적 구조를 가지고 있습니다. <br>
예를 들어 121.7.106.83처럼 각 숫자는 바이트를 나타내며 0~255 사이의 값을 가집니다. <br>
IP 주소가 계층적 구조라는 것은 왼쪽에서 오른쪽으로 읽을수록 그 호스트가 인터넷의 어느 부분에 있는지 더 정확히 알 수 있다는 뜻입니다. <br>
이는 우리가 주소를 읽을 때 오른쪽으로 갈수록 건물의 위치를 더 구체적으로 알 수 있는 것과 비슷합니다.

### 2.4.1 DNS가 제공하는 서비스

호스트를 식별하는 방법에는 호스트 이름과 IP 주소가 있습니다. <br>
사람은 기억하기 쉬운 호스트 이름을 선호하지만, 라우터는 고정 길이와 계층 구조를 가진 IP 주소를 선호합니다. <br>
이 차이를 연결하기 위해, 우리는 전화번호 안내 서비스와 유사한 서비스가 필요합니다. 이것이 바로 DNS(Domain Name System)의 주요 기능입니다. <br>
DNS는 (1) 계층적 구조를 가진 DNS 서버들로 이루어진 분산 데이터베이스이자, (2) 모든 호스트가 이 분산 데이터베이스를 조회할 수 있게 해주는 응용 계층 프로토콜입니다. <br>
DNS 서버는 주로 UNIX 시스템에서 BIND(Berkeley Internet Name Domain) 소프트웨어를 실행합니다. DNS 프로토콜은 UDP 위에서 동작하며, 포트 번호는 53번을 사용합니다.

DNS는 HTTP, SMTP 등 다른 응용 계층 프로토콜과 함께 사용됩니다. 이들 프로토콜은 사용자가 입력한 호스트 이름을 IP 주소로 변환할 때 DNS를 사용합니다. <br>
예를 들어, 어떤 사용자의 브라우저가 www.someschool.edu/index.html이라는 URL을 요청하면, 해당 사용자의 호스트가 www.someschool.edu의 IP 주소를 먼저 알아야 HTTP 요청을 보낼 수 있습니다. 이 과정은 다음과 같습니다:

1. 사용자의 컴퓨터에 DNS 클라이언트가 실행 중이어야 합니다.
2. 브라우저는 URL에서 호스트 이름(www.someschool.edu)을 추출해 DNS 클라이언트에 전달합니다.
3. DNS 클라이언트는 해당 호스트 이름을 포함한 질의 메시지를 DNS 서버에 전송합니다.
4. DNS 클라이언트는 호스트 이름에 대응하는 IP 주소가 담긴 응답을 받습니다.
5. 브라우저가 IP 주소를 받으면, 해당 주소의 HTTP 서버와 포트 80번으로 TCP 연결을 맺을 수 있습니다.

이 과정에서 DNS는 인터넷 응용 프로그램에 (때로는 필수적인) 지연을 추가합니다. 다행히도, 필요한 IP 주소는 대개 가까운 DNS 서버에 캐시되어 있어 DNS 네트워크 트래픽과 평균 지연을 줄일 수 있습니다. <br>
DNS는 호스트 이름을 IP 주소로 변환하는 것 외에도 몇 가지 중요한 서비스를 제공합니다:

- **호스트 별칭(Host aliasing):** 긴 호스트 이름에 대해 더 간단한 별칭을 부여할 수 있습니다. 예: relay1.west-coast.enterprise.com은 enterprise.com이나 www.enterprise.com 같은 별칭을 가질 수 있습니다. 별칭을 통해 DNS 서버에 질의하여 정규 호스트 이름과 IP 주소를 얻을 수 있습니다.
- **메일 서버 별칭(Mail server aliasing):** 이메일 주소는 기억하기 쉬워야 합니다. 예를 들어, Bob의 Yahoo 메일 주소는 bob@yahoo.mail처럼 간단해야 하지만, 실제 Yahoo 메일 서버의 호스트 이름은 더 복잡합니다(예: relay1.west-coast.yahoo.com). MX 레코드를 이용해 기업의 메일 서버와 웹 서버에 동일한 별칭을 부여할 수 있습니다.
- **부하 분산(Load distribution):** DNS는 여러 복제 서버(replica server) 간에 트래픽을 분산하는 데도 사용됩니다. 예를 들어 cnn.com은 여러 서버에 복제되어 있고 각 서버는 다른 IP 주소를 가집니다. DNS 서버는 질의마다 IP 주소 목록의 순서를 회전시켜 트래픽을 분산합니다.

### DNS: 클라이언트-서버 패러다임을 통한 핵심 네트워크 기능

DNS 프로토콜은 HTTP, FTP, SMTP처럼 응용 계층 프로토콜입니다. <br>
두 단말 장치 간에 동작하고, 마스터-슬레이브 구조를 사용하며, 전송 계층 프로토콜에 의존해 DNS 메시지를 전달합니다. <br>
하지만 DNS는 웹, 파일 전송, 이메일 서비스와 달리 사용자와 직접 상호작용하지 않습니다. DNS는 인터넷의 핵심 서비스로, 다른 응용 프로그램과 소프트웨어에 호스트 이름을 IP 주소로 변환해주는 역할을 합니다.

### 2.4.2 DNS 동작 개요

DNS 서비스가 어떻게 동작하는지 개념적으로 살펴보겠습니다. 논의의 초점은 호스트 이름을 IP 주소로 변환하는 과정입니다. <br>
사용자 컴퓨터에서 실행 중인 응용 프로그램(브라우저나 이메일 클라이언트 등)이 호스트 이름을 IP 주소로 변환해야 할 때 DNS 클라이언트를 호출합니다. <br>
예를 들어, Unix 기반 시스템에서는 gethostbyname() 함수를 호출합니다. DNS 클라이언트는 질의 메시지를 UDP 데이터그램(포트 53)을 통해 네트워크로 전송합니다. 약간의 지연(몇 밀리초~몇 초) 후, DNS 클라이언트는 IP 주소가 담긴 응답을 받게 됩니다.

DNS의 가장 단순한 설계는 전 세계 모든 호스트의 이름-주소 매핑을 한 대의 DNS 서버에 저장하는 것입니다. 그러나 인터넷의 호스트 수가 매우 많아 이 방식은 현실적이지 않습니다. 중앙 집중식 설계의 문제점은 다음과 같습니다:

- **단일 장애점:** DNS 서버가 고장나면 인터넷 전체가 마비됩니다.
- **트래픽 문제:** 하나의 서버가 모든 DNS 요청을 처리해야 합니다.
- **거리 문제:** 서버가 모든 클라이언트와 가까울 수 없습니다. 예를 들어, 서버가 뉴욕에 있으면 호주에서 온 요청은 먼 거리를 거쳐야 하므로 지연이 큽니다.
- **관리 문제:** 서버가 모든 호스트 정보를 저장하고 자주 업데이트해야 합니다.

결국, DNS는 분산 시스템으로 설계되었습니다. DNS는 분산 데이터베이스의 훌륭한 구현 사례입니다.

#### 분산, 계층적 데이터베이스

<img width="738" height="297" alt="Image" src="https://github.com/user-attachments/assets/0727f461-2bef-4d38-95b9-7b13be1b884b" />

DNS 시스템은 많은 서버가 계층적으로 구성되어 전 세계에 분산되어 있습니다. <br>
한 대의 DNS 서버가 모든 정보를 가지는 것이 아니라, 여러 DNS 서버에 분산되어 저장됩니다. <br>
대략적으로 DNS 서버는 세 가지로 구분됩니다: 루트 DNS 서버(root DNS servers), 최상위 도메인 DNS 서버(top-level domain, TLD DNS servers), 권한 DNS 서버(authoritative DNS servers)입니다.

예를 들어, DNS 클라이언트가 www.amazon.com의 IP 주소를 요청하면, 먼저 루트 DNS 서버에 질의하고, 루트 서버는 com TLD 서버의 IP 주소들을 반환합니다. <br>
클라이언트는 그 중 하나의 TLD 서버에 질의하고, TLD 서버는 amazon.com의 권한 DNS 서버의 IP 주소들을 반환합니다. 마지막으로, 클라이언트는 권한 DNS 서버에 질의해 www.amazon.com의 IP 주소를 얻습니다.

<img width="737" height="390" alt="Image" src="https://github.com/user-attachments/assets/7e0f7b10-fc27-4f71-bf1c-de9c92bb3fe7" />

- **루트 DNS 서버:** 2016년 기준, 전 세계에 400대 이상의 루트 DNS 서버가 존재합니다. 13개 그룹으로 나뉘어 관리되며, 각 그룹의 서버와 IP 주소는 [Root Servers 2016]에서 확인할 수 있습니다. 루트 서버는 TLD 서버의 IP 주소를 제공합니다.
- **최상위 도메인 DNS 서버(TLD DNS servers):** com, org, net, edu, gov 등 모든 TLD마다 하나 이상의 TLD 서버가 있습니다. 예를 들어 com TLD 서버는 Verisign이, edu TLD 서버는 Educause가 관리합니다. TLD 서버는 권한 DNS 서버의 IP 주소를 제공합니다.
- **권한 DNS 서버(authoritative DNS servers):** 인터넷에 공개 서비스(웹, 이메일 등)를 제공하는 조직은 도메인 이름에 대응하는 IP 주소를 DNS에 등록해야 합니다. 각 조직의 권한 DNS 서버가 그 정보를 저장합니다. 조직은 직접 서버를 운영하거나 서비스 업체에 위탁할 수 있습니다.

<img width="628" height="822" alt="Image" src="https://github.com/user-attachments/assets/900875d0-2058-4ec8-92f8-aa0a2483c32f" />

이 외에도 **로컬 DNS 서버(local DNS server)** 가 중요합니다. ISP(가정, 기업 등)는 자체 로컬 DNS 서버를 보유하며, 사용자는 ISP로부터 로컬 DNS 서버의 IP 주소를 할당받습니다. DNS 질의는 먼저 로컬 DNS 서버에 전달되고, 이후 계층 구조의 서버로 전달됩니다. <br>
예시: cse.nyu.edu가 gaia.cs.umass.edu의 IP 주소를 조회할 때, NYU의 로컬 DNS 서버(dns.nyu.edu)는 루트 DNS 서버에 질의해 edu TLD 서버의 IP 주소를 얻고, 다시 TLD 서버에 질의해 UMASS의 권한 DNS 서버(dns.umass.edu)의 IP 주소를 얻은 뒤, 권한 DNS 서버에 질의해 최종 IP 주소를 얻습니다. <br>
이 과정에서 총 8개의 DNS 메시지(4번 요청, 4번 응답)가 오갑니다.

DNS 질의에는 **재귀 질의(recursive query)** 와 **반복 질의(iterative query)** 가 있습니다. 일반적으로 클라이언트에서 로컬 DNS 서버로의 요청만 재귀 질의이고, 이후는 반복 질의입니다.

<img width="602" height="875" alt="Image" src="https://github.com/user-attachments/assets/0387c057-7cc1-4cca-9e76-8ec25208d1fa" />

#### DNS 캐싱

DNS 시스템은 캐싱을 통해 지연과 트래픽을 줄입니다. DNS 서버는 받은 응답을 메모리에 저장하고, 같은 질의가 들어오면 캐시된 정보를 바로 응답합니다. <br>
캐시된 정보는 일정 시간이 지나면 삭제됩니다(일반적으로 2일). 예를 들어, apricot.nyu.edu가 cnn.com의 IP 주소를 질의한 뒤, 몇 시간 후 kiwi.nyu.edu가 같은 질의를 하면 로컬 DNS 서버가 바로 응답할 수 있습니다.

### 2.4.3 DNS 레코드와 메시지

DNS 데이터베이스는 리소스 레코드(resource records, RRs)를 저장합니다. 각 DNS 응답에는 하나 이상의 리소스 레코드가 포함됩니다. 리소스 레코드는 네 가지 필드(Name, Value, Type, TTL)로 구성됩니다.

- **Type=A:** Name은 호스트 이름, Value는 IP 주소입니다. 예: (relay1.bar.foo.com, 145.37.93.126)
- **Type=NS:** Name은 도메인 이름, Value는 해당 도메인의 권한 DNS 서버의 이름입니다. 예: (foo.com, dns.foo.com, NS)
- **Type=CNAME:** Name은 호스트 별칭, Value는 정규 호스트 이름입니다. 예: (foo.com, relay1.bar.foo.com, CNAME)
- **Type=MX:** Name은 메일 서버 별칭, Value는 정규 메일 서버 이름입니다. 예: (foo.com, mail.bar.foo.com, MX)

<img width="764" height="463" alt="Image" src="https://github.com/user-attachments/assets/31f6b64a-c32b-417a-82d3-ece76886012d" />

DNS 메시지는 질의(query)와 응답(reply) 두 가지이며, 포맷은 동일합니다. 주요 필드는 다음과 같습니다:

- **헤더(header):** 첫 12바이트, 메시지 식별자, 플래그(질의/응답, 권한, 재귀 요청/가능 등), 레코드 개수 등
- **질의 섹션(question section):** 질의할 호스트 이름과 타입
- **응답 섹션(answer section):** 질의에 대한 리소스 레코드
- **권한 섹션(authority section):** 다른 권한 DNS 서버의 정보
- **추가 섹션(additional section):** 추가 정보(예: MX 타입일 때 메일 서버의 IP 주소 등)

nslookup 프로그램을 사용하면 직접 DNS 질의를 보낼 수 있습니다. Windows나 UNIX에서 터미널에 “nslookup”을 입력하면 실행됩니다.

### DNS 데이터베이스에 레코드 삽입

새로운 도메인을 등록할 때, 도메인 등록업체(registrar)가 도메인 고유성을 확인하고 DNS 데이터베이스에 정보를 입력합니다. <br>
등록 시, 권한 DNS 서버의 이름과 IP 주소도 함께 보고해야 합니다. 예를 들어, networkutopia.com을 등록하면, DNS 서버의 이름과 IP 주소가 com TLD 서버에 NS, A 레코드로 입력됩니다. <br>
웹 서버와 메일 서버의 Type A, MX 레코드도 권한 DNS 서버에 입력해야 합니다. 최근에는 DNS 동적 업데이트 기능을 통해 레코드를 동적으로 추가/삭제할 수 있습니다.

> ### DNS 취약점
> DNS는 인터넷의 핵심 인프라로, 공격에 취약할 수 있습니다. 대표적인 공격은 DNS 서버에 대한 DDoS(분산 서비스 거부) 공격입니다. <br>
> 예를 들어, 2002년 10월 21일에는 13대 루트 DNS 서버에 대규모 ICMP ping 공격이 있었지만, 대부분의 서버가 패킷 필터링으로 보호되어 큰 피해는 없었습니다. 대부분의 질의는 캐시 덕분에 루트 서버까지 도달하지 않습니다.
> 
> 더 효과적인 DDoS 공격은 TLD 서버를 대상으로 하는 것입니다. TLD 서버는 필터링이 어렵고, 캐시로 완전히 우회할 수 없습니다. <br>
> 그 외에도 중간자 공격(man-in-the-middle)이나 DNS 캐시 오염 공격(DNS poisoning)이 있습니다. 이들은 악성 응답을 보내 사용자를 공격자의 사이트로 유도할 수 있지만, 실제로 구현하기는 어렵습니다. <br>
> 
> 결론적으로, DNS는 공격에도 매우 견고함을 입증했습니다. 지금까지 DNS 서비스가 완전히 중단된 적은 없습니다.