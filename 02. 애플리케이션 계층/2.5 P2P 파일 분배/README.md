# 2.5 Peer-to-Peer 파일 배포  

지금까지 이 챕터에서 다룬 서비스들 — 웹, 이메일, DNS — 모두 클라이언트-서버(주종식) 구조를 사용하며, 항상 온라인 상태로 서비스를 제공하는 서버에 크게 의존합니다. <br>
앞서 2.1.1절에서 언급한 것처럼, 만약 P2P(피어 투 피어) 구조를 사용한다면, 항상 온라인인 서버에 거의 의존하지 않아도 됩니다. <br>
대신에 여러 대의 컴퓨터(피어)가 불안정하게 연결되어 서로 직접 통신합니다. 피어는 서비스 제공업체가 소유한 것이 아니라 일반 사용자가 소유한 데스크톱이나 노트북입니다.

이번 절에서는 P2P 네트워크에서 자연스럽게 생기는 응용 서비스, 즉 하나의 서버가 많은 피어들 사이에서 대용량 파일을 공유하는 방법을 소개합니다. <br>
이 파일은 최신 버전의 리눅스 운영체제, 기존 OS나 애플리케이션의 패치, MP3 음악 파일, MPEG 비디오 파일 등이 될 수 있습니다. <br>
클라이언트-서버 구조로 파일을 공유하면, 서버가 각 피어에게 직접 파일을 복사해서 보내야 하므로 서버에 큰 부담이 되고, 서버의 대역폭이 많이 소모됩니다. <br>
P2P 파일 공유 시스템에서는 각 피어가 다른 피어로부터 받은 파일을 다시 다른 사람에게 전달할 수 있으므로, 서버와 함께 파일 공유를 도와줄 수 있습니다. <br>
2016년 기준, 가장 인기 있는 P2P 파일 공유 프로토콜은 BitTorrent입니다. BitTorrent 프로토콜은 Bram Cohen이 만들었으며, 현재는 다양한 BitTorrent 클라이언트가 이 프로토콜을 지원합니다. <br>
이는 여러 브라우저가 HTTP 프로토콜을 따르는 것과 비슷합니다. 다음 소절에서는 파일 공유라는 응용 맥락에서 P2P 구조의 자기 확장성(self-scalability)을 살펴보고, BitTorrent의 주요 특징과 기능을 소개합니다.

### P2P 구조의 확장성

<img width="719" height="657" alt="Image" src="https://github.com/user-attachments/assets/c59a73a5-1821-4976-812c-e8f328dd1d40" />

### BitTorrent

BitTorrent는 매우 유명한 파일 전송용 P2P 프로토콜입니다. <br>
BitTorrent 용어에서는 "특정 파일 전송에 참여하는 모든 피어 집합"을 토렌트(torrent)라고 부릅니다. <br>
한 토렌트 내의 피어들은 서로 다른 피어에게서 파일의 동일 크기 청크(chunk)를 다운로드합니다. 청크 크기는 일반적으로 256kB입니다. <br>
한 피어가 토렌트에 처음 들어오면 아무 청크도 없지만, 시간이 지나면서 점점 더 많은 청크를 모읍니다. 청크를 다운로드하는 동시에, 해당 청크를 다른 피어에게 업로드합니다. <br>
전체 파일을 받으면, 피어는 (이기적으로) 토렌트를 떠나거나 (이타적으로) 남아서 다른 피어에게 청크를 계속 업로드할 수 있습니다. 또한 피어는 파일을 받는 도중 언제든 토렌트를 떠났다가 다시 들어올 수도 있습니다.

BitTorrent의 동작 방식을 좀 더 자세히 살펴보겠습니다. BitTorrent는 비교적 복잡한 프로토콜과 시스템이므로, 주요 메커니즘만 설명하고 세부 사항은 생략합니다. <br>
모든 토렌트에는 트래커(tracker)라는 인프라 노드가 있습니다. 피어가 토렌트에 참여하면 트래커에 등록하고, 주기적으로 트래커에 자신이 아직 토렌트에 남아 있음을 알립니다. <br>
이로 인해 트래커는 현재 토렌트에 참여 중인 피어를 추적할 수 있습니다. 한 토렌트에는 10명 미만 또는 1,000명 이상의 피어가 동시에 파일 전송에 참여할 수 있습니다.

#### BitTorrent를 통한 파일 전송

<img width="720" height="568" alt="Image" src="https://github.com/user-attachments/assets/8b2895e6-0ff8-40cb-8d0b-bc637f19b083" />

새로운 피어(예: Alice)가 토렌트에 참여하면, 트래커는 현재 토렌트에 참여 중인 피어 중 임의로 하위 집합(예: 50명)을 선택해 Alice에게 IP 주소를 전달합니다. <br>
Alice는 이 IP 목록의 모든 피어와 동시(concurrent) TCP 연결을 시도합니다. Alice와 TCP 연결에 성공한 피어들을 "이웃 피어(neighboring peers)"라고 부릅니다(Alice에게 이웃 피어가 세 명이지만, 실제로는 더 많습니다). <br>
시간이 지나면서 일부 피어는 떠나고, 목록에 없는 다른 피어가 Alice와 TCP 연결을 시도할 수도 있습니다. 따라서 한 피어의 이웃 피어는 변동될 수 있습니다.

아무 시점에나 각 피어는 파일의 일부 청크만 가지고 있고, 서로 다른 피어가 서로 다른 청크 집합을 가질 수 있습니다. <br>
Alice는 TCP 연결을 통해 이웃 피어들에게 그들이 가진 청크 목록을 주기적으로 요청합니다. Alice가 L명의 이웃을 가졌다면, L개의 청크 목록을 받게 됩니다. 이 목록을 바탕으로 Alice는 자신이 아직 가지지 않은 청크를 요청할 수 있습니다(역시 TCP 연결을 통해).

따라서 아무 시점에나 Alice는 파일의 일부 청크 집합을 가지고 있고, 이웃들이 어떤 청크를 가지고 있는지도 압니다. <br>
이 정보를 바탕으로 Alice는 두 가지 중요한 결정을 내려야 합니다. 첫째, 어떤 청크를 먼저 요청할 것인가? 둘째, 어느 이웃에게 요청할 것인가?  

청크 요청 결정 시, Alice는 "희귀 우선(rarest first)" 전략을 사용합니다. <br>
즉, 아직 가지지 않은 청크 중, 이웃 중에서 가장 적게 가지고 있는(가장 희귀한) 청크를 우선적으로 요청합니다. <br>
이렇게 하면 희귀한 청크가 더 빨리 재배포되어, 토렌트 내 모든 청크의 복사본 수가 대체로 비슷해집니다.

(청크 요청이 들어오면) BitTorrent는 영리한 거래 알고리즘으로 응답 우선순위를 결정합니다. <br>
이 알고리즘의 기본 개념은: Alice는 자신에게 데이터를 가장 빠르게 제공하는 이웃을 우선적으로 응답 대상으로 선택합니다. <br>
구체적으로, 각 이웃의 전송 속도를 지속적으로 측정해 가장 빠른 4명을 선택합니다. Alice는 이 4명에게 청크를 전송합니다. 10초마다 전송 속도를 다시 측정해 이 4명의 명단을 변경할 수 있습니다. BitTorrent 용어로 이 4명을 "언초크(unchoked)"라고 합니다.  

또한 30초마다 Alice는 임의의 이웃 한 명을 선택해 청크를 전송합니다. <br>
임의로 선택된 이웃을 Bob이라 하면, BitTorrent 용어로 Bob은 "낙관적 언초크(optimistically unchoked)"입니다. <br>
Alice가 Bob에게 데이터를 보내기 시작하면, Alice가 Bob의 이웃 중 가장 빠른 4명에 들어갈 수도 있고, 그럴 경우 Bob도 Alice에게 데이터를 보내기 시작합니다. <br>
만약 Bob이 Alice에게 데이터를 빠르게 보내면, Bob도 Alice의 4명 중 하나가 되어 서로 데이터를 교환합니다. <br>
즉, 30초마다 Alice는 새로운 거래 상대를 임의로 선택해 거래하며, 두 사람이 거래 결과에 만족하면 서로를 상위 4명으로 유지하고 데이터를 교환합니다. <br>
더 좋은 거래 상대가 나타나면 명단이 바뀝니다. 이 알고리즘 덕분에 적절한 업로드 속도로 데이터 전송이 가능한 피어끼리 쉽게 연결되고, 임의 이웃 선택 덕분에 신규 피어도 청크를 얻어 거래할 수 있습니다. <br>
이 5명(상위 4명과 임의 선택 1명) 외의 피어는 "초크(choked)"라고 하며, Alice로부터 청크를 받지 못합니다. <br>
BitTorrent에는 이 외에도 여러 흥미로운 메커니즘(피스, 파이프라이닝, 임의 우선 선택, 엔드게임 모드, 안티 스너빙 등)이 있습니다.

이 거래 알고리즘의 보상 메커니즘은 "tit-for-tat(투-포-탯, 맞교환)" 전략이라고도 합니다. <br>
연구에 따르면 이 보상 메커니즘을 교묘하게 우회할 수 있다는 것이 밝혀졌습니다. <br>
그럼에도 불구하고 BitTorrent 생태계는 매우 성공적이며, 수백만 명의 동시 접속 피어가 수십만 개의 토렌트에서 파일을 공유합니다. <br>
만약 BitTorrent에 이런 "맞교환" 또는 유사한 설계가 없다면, 나머지 기능이 그대로여도 BitTorrent는 존재하지 못했을 것입니다. 대부분의 사용자가 무임승차(freerider)가 되었을 것이기 때문입니다 [Saroiu 2002].

P2P 논의의 마지막으로, 또 다른 P2P 응용 프로그램인 분산 해시 테이블(Distributed Hash Table, DHT)을 간단히 소개합니다. <br>
DHT는 매우 단순한 데이터베이스로, 데이터가 P2P 시스템의 여러 피어에 분산 저장됩니다. <br>
DHT는 이미 널리 구현되었으며(예: BitTorrent에서), 연구 주제로도 활발히 다뤄지고 있습니다..