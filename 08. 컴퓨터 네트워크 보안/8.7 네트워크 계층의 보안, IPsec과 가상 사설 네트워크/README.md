## 8.7 네트워크 계층의 보안: IPsec과 가상 사설 네트워크

**IP 보안 프로토콜(IP security protocol)**, 더 일반적으로 **IPsec**으로 알려진 프로토콜은 네트워크 계층에서 보안을 제공합니다.
IPsec은 호스트와 라우터를 포함한 모든 두 네트워크 계층 엔티티 간의 IP 데이터그램을 보호합니다.

많은 기관(기업, 정부 부서, 비영리 조직 등)이 IPsec을 사용하여 공용 인터넷을 통해 실행되는 **가상 사설 네트워크(VPN, Virtual Private Networks)** 를 생성합니다.

### 네트워크 계층 기밀성의 의미

IPsec의 세부 사항에 들어가기 전에, 네트워크 계층에서 기밀성을 제공한다는 것이 무엇을 의미하는지 한 걸음 물러서 생각해 봅시다.

네트워크 계층 엔티티 쌍(예: 두 라우터 사이, 두 호스트 사이, 또는 라우터와 호스트 사이) 간의 네트워크 계층 기밀성을 사용하면, 송신 엔티티는 수신 엔티티에 보내는 모든 데이터그램의 **페이로드를 암호화**합니다.

암호화된 페이로드는 TCP 세그먼트, UDP 세그먼트, ICMP 메시지 등이 될 수 있습니다.
이러한 네트워크 계층 서비스가 있다면, 한 엔티티에서 다른 엔티티로 전송되는 모든 데이터(이메일, 웹 페이지, TCP 핸드셰이크 메시지, ICMP 및 SNMP와 같은 관리 메시지 포함)가 네트워크를 스니핑하는 제3자로부터 **숨겨집니다**.

이러한 이유로 네트워크 계층 보안은 **"포괄적 적용(blanket coverage)"** 을 제공한다고 합니다.

### 네트워크 계층 보안이 제공하는 서비스

기밀성 외에도 네트워크 계층 보안 프로토콜은 잠재적으로 다른 보안 서비스를 제공할 수 있습니다:

- **출발지 인증(source authentication)**: 수신 엔티티가 보안된 데이터그램의 출발지를 확인할 수 있습니다
- **데이터 무결성(data integrity)**: 수신 엔티티가 데이터그램이 전송 중에 변조되었는지 확인할 수 있습니다
- **재생 공격 방지(replay-attack prevention)**: 밥이 공격자가 삽입할 수 있는 중복 데이터그램을 탐지할 수 있습니다

IPsec이 실제로 이러한 모든 보안 서비스, 즉 기밀성, 출발지 인증, 데이터 무결성, 재생 공격 방지를 위한 메커니즘을 제공함을 곧 살펴볼 것입니다.

---

## 8.7.1 IPsec과 가상 사설 네트워크 (VPNs)

여러 지리적 지역에 걸쳐 확장되는 기관은 종종 자체 **IP 네트워크**를 원합니다.
이를 통해 호스트와 서버가 안전하고 기밀스러운 방식으로 서로 데이터를 주고받을 수 있습니다.

이 목표를 달성하기 위해, 기관은 실제로 공용 인터넷과 완전히 **분리된** 독립적인 물리적 네트워크(라우터, 링크, DNS 인프라 포함)를 배포할 수 있습니다.
특정 기관에 전용된 이러한 분리된 네트워크를 **사설 네트워크(private network)** 라고 합니다.

당연히 사설 네트워크는 기관이 자체 물리적 네트워크 인프라를 구매, 설치, 유지해야 하므로 **매우 비쌀 수 있습니다**.

### VPN의 개념

사설 네트워크를 배포하고 유지하는 대신, 오늘날 많은 기관은 기존의 공용 인터넷을 통해 **VPN을 생성**합니다.
VPN을 사용하면 기관의 사무실 간 트래픽이 물리적으로 독립된 네트워크가 아닌 **공용 인터넷**을 통해 전송됩니다.

그러나 기밀성을 제공하기 위해 사무실 간 트래픽은 공용 인터넷에 진입하기 전에 **암호화**됩니다.

<img width="612" height="382" alt="Image" src="https://github.com/user-attachments/assets/b5e19ce9-0105-473a-b33a-5b45be2fb43a" />

VPN의 간단한 예가 그림 8.27에 나와 있습니다.
여기서 기관은 본사, 지사, 호텔 방에서 일반적으로 인터넷에 접속하는 출장 영업사원으로 구성됩니다.
(그림에는 영업사원 한 명만 표시되어 있습니다.)

이 VPN에서:
- 본사 내의 두 호스트가 서로 통신하거나 지사 내의 두 호스트가 통신할 때는 일반적인 **바닐라 IPv4**(즉, IPsec 서비스 없음)를 사용합니다
- 그러나 기관의 두 호스트가 **공용 인터넷을 거치는 경로**를 통해 통신할 때, 트래픽은 인터넷에 진입하기 전에 **암호화**됩니다

### VPN 작동 방식

그림 8.27의 맥락에서 VPN이 어떻게 작동하는지 간단한 예를 살펴봅시다.

본사의 호스트가 호텔에 있는 영업사원에게 IP 데이터그램을 보낼 때:
1. 본사의 게이트웨이 라우터가 바닐라 IPv4 데이터그램을 **IPsec 데이터그램**으로 변환합니다
2. 이 IPsec 데이터그램을 인터넷으로 전달합니다
3. 이 IPsec 데이터그램은 실제로 전통적인 IPv4 헤더를 가지고 있어, 공용 인터넷의 라우터들은 이것이 일반적인 IPv4 데이터그램인 것처럼 처리합니다
4. 그러나 그림 8.27에서 보듯이, IPsec 데이터그램의 페이로드에는 IPsec 처리에 사용되는 **IPsec 헤더**가 포함되어 있습니다
5. 또한 IPsec 데이터그램의 페이로드는 **암호화**되어 있습니다
6. IPsec 데이터그램이 영업사원의 노트북에 도착하면, 노트북의 OS가 페이로드를 복호화하고(데이터 무결성 검증과 같은 다른 보안 서비스 제공) 암호화되지 않은 페이로드를 상위 계층 프로토콜(예: TCP 또는 UDP)에 전달합니다

---

## 8.7.2 AH와 ESP 프로토콜

IPsec은 상당히 복잡한 동물입니다 - 12개 이상의 RFC에 정의되어 있습니다.
두 가지 중요한 RFC는 전체 IP 보안 아키텍처를 설명하는 **RFC 4301**과 IPsec 프로토콜 제품군의 개요를 제공하는 **RFC 6071**입니다.

IPsec 프로토콜 제품군에는 두 가지 주요 프로토콜이 있습니다:
- **인증 헤더(AH, Authentication Header)** 프로토콜
- **캡슐화 보안 페이로드(ESP, Encapsulation Security Payload)** 프로토콜

### AH vs ESP

소스 IPsec 엔티티(일반적으로 호스트 또는 라우터)가 목적지 엔티티(역시 호스트 또는 라우터)에 보안 데이터그램을 보낼 때, **AH 프로토콜 또는 ESP 프로토콜** 중 하나를 사용합니다.

- **AH 프로토콜**: 출발지 인증과 데이터 무결성을 제공하지만 **기밀성을 제공하지 않습니다**
- **ESP 프로토콜**: 출발지 인증, 데이터 무결성, **그리고** 기밀성을 제공합니다

기밀성이 VPN 및 기타 IPsec 애플리케이션에 종종 중요하기 때문에, ESP 프로토콜이 AH 프로토콜보다 **훨씬 더 널리 사용**됩니다.

IPsec을 이해하기 쉽게 하고 복잡성을 피하기 위해, 이후로는 **ESP 프로토콜에만 집중**합니다.
AH 프로토콜에 대해 더 알고 싶은 독자는 RFC와 다른 온라인 리소스를 탐색하는 것이 좋습니다.

---

## 8.7.3 보안 연관 (Security Associations)

IPsec 데이터그램은 두 호스트 사이, 두 라우터 사이, 또는 호스트와 라우터 사이와 같은 **네트워크 엔티티 쌍 사이**에서 전송됩니다.

소스 엔티티에서 목적지 엔티티로 IPsec 데이터그램을 보내기 전에, 소스와 목적지 엔티티는 네트워크 계층 논리적 연결을 생성합니다.
이 논리적 연결을 **보안 연관(SA, Security Association)** 이라고 합니다.

### SA의 특성

SA는 **단방향(simplex)** 논리적 연결입니다.
즉, 소스에서 목적지로만 단방향입니다.

두 엔티티가 서로에게 보안 데이터그램을 보내려면, **각 방향에 하나씩** 두 개의 SA(즉, 두 개의 논리적 연결)가 설정되어야 합니다.

### SA의 상태 정보

예를 들어, 그림 8.27의 기관 VPN을 다시 고려해 봅시다.
이 기관은 본사, 지사, *n*명의 출장 영업사원으로 구성됩니다.

본사와 지사 사이에 양방향 IPsec 트래픽이 있고, 본사와 영업사원 사이에도 양방향 IPsec 트래픽이 있다고 가정합시다.
이 VPN에는 몇 개의 SA가 있을까요?

이 질문에 답하기 위해, 본사 게이트웨이 라우터와 지사 게이트웨이 라우터 사이에 두 개의 SA(각 방향에 하나씩)가 있고, 각 영업사원의 노트북에 대해 두 개의 SA(각 방향에 하나씩)가 있습니다.
따라서 총 **(2 + 2n)** 개의 SA가 있습니다.

그러나 **게이트웨이 라우터나 노트북에 의해 인터넷으로 전송되는 모든 트래픽이 IPsec으로 보호되는 것은 아님**을 명심하세요.
예를 들어, 본사의 호스트가 웹 서버(예: Amazon 또는 Google)에 접속하려 할 수 있습니다.
따라서 게이트웨이 라우터(및 노트북)는 바닐라 IPv4 데이터그램과 보안된 IPsec 데이터그램 모두를 인터넷으로 내보냅니다.

### SA 내부 살펴보기

<img width="536" height="196" alt="Image" src="https://github.com/user-attachments/assets/b8b94aa6-0105-4827-8735-41d171c75adc" />

SA 내부를 살펴보겠습니다.
구체적으로 그림 8.28의 맥락에서 라우터 R1에서 라우터 R2로의 SA에 대해 살펴봅시다.
(R1을 본사 게이트웨이 라우터로, R2를 지사 게이트웨이 라우터로 생각할 수 있습니다.)

라우터 R1은 이 SA에 대한 상태 정보를 유지하며, 이는 다음을 포함합니다:

- SA에 대한 32비트 식별자인 **보안 매개변수 인덱스(SPI, Security Parameter Index)**
- SA의 출발지 인터페이스(이 경우 200.168.1.100)와 목적지 인터페이스(이 경우 193.68.2.23)
- 사용할 암호화 유형(예: CBC를 사용하는 3DES)
- **암호화 키**
- 무결성 검사 유형(예: MD5를 사용하는 HMAC)
- **인증 키**

R1이 이 SA를 통해 전달할 IPsec 데이터그램을 구성해야 할 때마다, 이 상태 정보에 접근하여 데이터그램을 인증하고 암호화하는 방법을 결정합니다.
마찬가지로 라우터 R2는 이 SA에 대한 동일한 상태 정보를 유지하며, SA에서 도착하는 모든 IPsec 데이터그램을 인증하고 복호화하는 데 이 정보를 사용합니다.

### 보안 연관 데이터베이스 (SAD)

IPsec 엔티티(라우터 또는 호스트)는 종종 많은 SA에 대한 상태 정보를 유지합니다.
예를 들어, 그림 8.27의 VPN 예에서 *n*명의 영업사원이 있으면, 본사 게이트웨이 라우터는 **(2 + 2n)** 개의 SA에 대한 상태 정보를 유지합니다.

IPsec 엔티티는 모든 SA에 대한 상태 정보를 **보안 연관 데이터베이스(SAD, Security Association Database)** 에 저장합니다.
SAD는 엔티티의 OS 커널에 있는 데이터 구조입니다.

---

## 8.7.4 IPsec 데이터그램

SA를 설명했으니 이제 실제 IPsec 데이터그램을 설명할 수 있습니다.

IPsec에는 두 가지 다른 패킷 형태가 있습니다:
- **터널 모드(tunnel mode)**: VPN에 더 적합하며 더 널리 배포됨
- **전송 모드(transport mode)**

IPsec을 더 이해하기 쉽게 하고 복잡성을 피하기 위해, 이후로는 **터널 모드에만 집중**합니다.
터널 모드를 확실히 이해하면 전송 모드에 대해 스스로 쉽게 배울 수 있을 것입니다.

### IPsec 데이터그램 형식

<img width="542" height="222" alt="Image" src="https://github.com/user-attachments/assets/cb18c7c9-4021-4925-8c36-ef941ed48a6f" />

IPsec 데이터그램의 패킷 형식은 그림 8.29에 나와 있습니다.

그림 8.28의 맥락에서 IPsec 필드를 살펴봅시다.
라우터 R1이 호스트 172.16.1.17(본사 네트워크)에서 호스트 172.16.2.48(지사 네트워크)으로 향하는 일반 IPv4 데이터그램을 받았다고 가정합니다.

라우터 R1은 이 "원본 IPv4 데이터그램"을 다음 레시피를 사용하여 IPsec 데이터그램으로 변환합니다:

1. 원본 IPv4 데이터그램(원본 헤더 필드 포함!)의 뒤에 **"ESP 트레일러"** 필드를 추가합니다
2. SA에서 지정된 알고리즘과 키를 사용하여 결과를 **암호화**합니다
3. 이 암호화된 양의 앞에 **"ESP 헤더"** 라는 필드를 추가합니다. 결과 패키지를 **"엔칠라다(enchilada)"** 라고 합니다
4. SA에서 지정된 알고리즘과 키를 사용하여 **전체 엔칠라다에 대한 인증 MAC**을 생성합니다
5. 엔칠라다의 뒤에 MAC을 추가하여 **페이로드**를 형성합니다
6. 마지막으로, 모든 클래식 IPv4 헤더 필드(일반적으로 20바이트 길이)를 가진 **완전히 새로운 IP 헤더**를 생성하여 페이로드 앞에 추가합니다

### ESP 트레일러와 ESP 헤더

**ESP 트레일러**는 세 개의 필드로 구성됩니다:
- **패딩(Padding)**: 블록 암호는 암호화할 메시지가 블록 길이의 정수 배가 되어야 합니다. 패딩(의미 없는 바이트로 구성)은 원본 데이터그램에 추가될 때(패드 길이 및 다음 헤더 필드와 함께) 결과 "메시지"가 정수 개의 블록이 되도록 합니다.
- **패드 길이(Pad length)**: 수신 엔티티에 얼마나 많은 패딩이 삽입되었는지(따라서 제거해야 하는지) 나타냅니다
- **다음 헤더(Next header)**: 페이로드 데이터 필드에 포함된 데이터 유형(예: UDP)을 식별합니다

페이로드 데이터(일반적으로 원본 IP 데이터그램)와 ESP 트레일러는 연결되어 **암호화**됩니다.

이 암호화된 단위 앞에 **ESP 헤더**가 추가됩니다. ESP 헤더는 평문으로 전송되며 두 필드로 구성됩니다:
- **SPI**: 수신 엔티티에 데이터그램이 속한 SA를 나타냅니다. 수신 엔티티는 SPI를 사용하여 SAD를 인덱싱하여 적절한 인증/복호화 알고리즘과 키를 결정할 수 있습니다.
- **시퀀스 번호**: **재생 공격을 방어**하는 데 사용됩니다

### 새 IP 헤더

결과 IPsec 데이터그램은 전통적인 IPv4 헤더 필드 뒤에 페이로드가 오는 **정당한 IPv4 데이터그램**입니다.
그러나 이 경우 페이로드에는 ESP 헤더, 원본 IP 데이터그램, ESP 트레일러, ESP 인증 필드(원본 데이터그램과 ESP 트레일러가 암호화됨)가 포함됩니다.

원본 IP 데이터그램의 출발지 IP 주소는 172.16.1.17이고 목적지 IP 주소는 172.16.2.48입니다.
IPsec 데이터그램이 원본 IP 데이터그램을 포함하므로(암호화됨), 이러한 주소는 IPsec 패킷의 페이로드의 일부로 포함됩니다(그리고 암호화됩니다).

그러나 새 IP 헤더의 출발지와 목적지 IP 주소는 무엇일까요?
예상할 수 있듯이, 터널 양쪽 끝의 소스와 목적지 라우터 인터페이스로 설정됩니다.
즉, **200.168.1.100과 193.68.2.23**입니다.

또한 이 새 IPv4 헤더의 프로토콜 번호 필드는 TCP, UDP, SMTP가 아닌 **50**으로 설정되어, 이것이 ESP 프로토콜을 사용하는 IPsec 데이터그램임을 나타냅니다.

### IPsec 데이터그램 처리

R1이 IPsec 데이터그램을 공용 인터넷으로 보낸 후, 많은 라우터를 거쳐 R2에 도달합니다.
이러한 라우터들은 각각 데이터그램이 일반 데이터그램인 것처럼 처리합니다 - IPsec으로 암호화된 데이터를 전달하고 있다는 것을 전혀 모릅니다.

외부 헤더의 목적지 IP 주소가 R2이므로, 데이터그램의 최종 목적지는 R2입니다.

R2가 IPsec 데이터그램을 받으면:
1. R2는 데이터그램의 목적지 IP 주소가 R2 자체임을 관찰합니다
2. R2는 따라서 데이터그램을 처리합니다
3. 프로토콜 필드(가장 왼쪽 IP 헤더에 있음)가 50이므로, R2는 IPsec ESP 처리를 데이터그램에 적용해야 함을 알게 됩니다
4. 먼저, 엔칠라다를 들여다보며 R2는 SPI를 사용하여 데이터그램이 속한 SA를 결정합니다
5. 둘째, 엔칠라다의 MAC을 계산하고 ESP MAC 필드의 값과 일치하는지 확인합니다
6. 셋째, 시퀀스 번호 필드를 확인하여 데이터그램이 새 것이며(재생된 데이터그램이 아님)을 검증합니다
7. 넷째, SA와 연관된 복호화 알고리즘과 키를 사용하여 암호화된 단위를 복호화합니다
8. 다섯째, 패딩을 제거하고 원본의 바닐라 IP 데이터그램을 추출합니다
9. 마지막으로, 여섯째, 원본 데이터그램을 지사 네트워크로 전달하여 최종 목적지로 향합니다

### 보안 정책 데이터베이스 (SPD)

실제로 해결해야 할 또 다른 중요한 미묘함이 있습니다.

R1이 본사 네트워크의 호스트로부터 (보안되지 않은) 데이터그램을 받고, 그 데이터그램이 본사 외부의 목적지 IP 주소로 향할 때, R1은 다음을 어떻게 알까요:
- IPsec으로 처리할 것인지 IPsec 데이터그램으로 변환해야 하는지?
- IPsec으로 처리해야 한다면, SAD의 많은 SA 중 어느 것을 사용하여 IPsec 데이터그램을 구성해야 하는지?

문제는 다음과 같이 해결됩니다:
SAD와 함께, IPsec 엔티티는 **보안 정책 데이터베이스(SPD, Security Policy Database)** 라는 또 다른 데이터 구조도 유지합니다.

SPD는 출발지 IP 주소, 목적지 IP 주소, 프로토콜 유형의 함수로 어떤 유형의 데이터그램이 IPsec 처리될 것인지 나타냅니다.
그리고 IPsec 처리될 것들에 대해서는 어떤 SA를 사용해야 하는지 나타냅니다.

어떤 의미에서 SPD의 정보는 도착하는 데이터그램에 대해 **"무엇을"** 해야 하는지를 나타내고, SAD의 정보는 **"어떻게"** 해야 하는지를 나타냅니다.

---

## IPsec 서비스 요약

IPsec이 정확히 어떤 서비스를 제공할까요?
공격자 트루디의 관점에서 이러한 서비스를 살펴봅시다.

트루디가 그림 8.28의 R1과 R2 사이 경로 어딘가에서 중간자(woman-in-the-middle)로 앉아 있다고 가정합니다.
이 논의에서 트루디가 SA에서 사용되는 인증 및 암호화 키를 **모른다고** 가정합니다.

트루디가 할 수 있는 것과 할 수 없는 것은 무엇일까요?

1. **원본 데이터그램을 볼 수 없습니다**: 실제로 원본 데이터그램의 데이터뿐만 아니라 프로토콜 번호, 출발지 IP 주소, 목적지 IP 주소도 트루디에게 숨겨집니다. SA를 통해 전송되는 데이터그램에 대해, 트루디는 데이터그램이 200.168.1.100에서 시작되어 193.68.2.23으로 향한다는 것만 알 수 있습니다. 그녀는 TCP, UDP, ICMP 데이터를 전달하는지, HTTP, SMTP 또는 다른 유형의 애플리케이션 데이터를 전달하는지 알 수 없습니다. 따라서 이 기밀성은 SSL보다 **훨씬 더 깊습니다**.

2. **데이터그램을 변조할 수 없습니다**: 둘째, 트루디가 SA의 데이터그램의 일부 비트를 뒤집어 변조하려 한다고 가정합니다. 이 변조된 데이터그램이 R2에 도착하면, (MAC을 사용한) 무결성 검사에 실패하여 트루디의 악의적인 시도를 다시 한 번 좌절시킵니다.

3. **R1으로 가장할 수 없습니다**: 셋째, 트루디가 R1으로 가장하여 출발지 200.168.1.100과 목적지 193.68.2.23의 IPsec 데이터그램을 생성한다고 가정합니다. 트루디의 공격은 R2에서 무결성 검사에 다시 실패하므로 헛수고입니다.

4. **재생 공격을 성공시킬 수 없습니다**: 마지막으로, IPsec이 시퀀스 번호를 포함하므로, 트루디는 성공적인 **재생 공격을 생성할 수 없습니다**.

요약하면, 이 절의 시작에서 주장한 대로, IPsec은 네트워크 계층을 통해 패킷을 처리하는 모든 장치 쌍 사이에 **기밀성, 출발지 인증, 데이터 무결성, 재생 공격 방지**를 제공합니다.

---

## 8.7.5 IKE: IPsec의 키 관리

VPN에 소수의 종단점만 있는 경우(예: 그림 8.28의 두 라우터만), 네트워크 관리자는 종단점의 SAD에 SA 정보(암호화/인증 알고리즘과 키, SPI)를 **수동으로 입력**할 수 있습니다.

이러한 "수동 키잉"은 수백 또는 수천 개의 IPsec 라우터와 호스트로 구성될 수 있는 대규모 VPN에서는 명백히 **비실용적**입니다.
대규모, 지리적으로 분산된 배포에는 SA를 생성하기 위한 자동화된 메커니즘이 필요합니다.

IPsec은 **IKE(Internet Key Exchange)** 프로토콜로 이를 수행합니다(RFC 5996에 지정됨).

### IKE의 특징

IKE는 SSL의 핸드셰이크와 몇 가지 유사점이 있습니다(8.6절 참조):
- 각 IPsec 엔티티는 엔티티의 공개키를 포함하는 **인증서**를 가지고 있습니다
- SSL과 마찬가지로 IKE 프로토콜에서 두 엔티티는 인증서를 교환하고, 인증 및 암호화 알고리즘을 협상하고, IPsec SA의 세션 키를 생성하기 위한 키 자료를 안전하게 교환합니다

SSL과 달리, IKE는 이러한 작업을 수행하기 위해 **두 단계**를 사용합니다.

### IKE 1단계

그림 8.28의 맥락에서 두 라우터 R1과 R2 사이의 이 두 단계를 살펴봅시다.

첫 번째 단계는 두 번의 메시지 쌍 교환으로 구성됩니다:

1. **첫 번째 메시지 교환**에서, 두 측은 **Diffie-Hellman**을 사용하여(Homework Problems 참조) 라우터들 사이에 양방향 **IKE SA**를 생성합니다. 혼란스럽게도, 이 양방향 IKE SA는 8.6.3절과 8.6.4절에서 논의한 IPsec SA와 완전히 다릅니다. IKE SA는 두 라우터 사이에 **인증되고 암호화된 채널**을 제공합니다. 이 첫 번째 메시지 쌍 교환에서, 암호화 및 인증을 위한 키가 IKE SA에 대해 설정됩니다. 또한 2단계에서 IPSec SA 키를 계산하는 데 사용될 **마스터 시크릿**이 설정됩니다. 이 첫 번째 단계에서 **RSA 공개 및 개인 키는 사용되지 않음**을 관찰하세요. 특히 R1도 R2도 자신의 개인키로 메시지에 서명하여 자신의 신원을 밝히지 않습니다.

2. **두 번째 메시지 교환**에서, 양쪽은 서로의 메시지에 서명하여 서로에게 자신의 신원을 밝힙니다. 그러나 메시지가 보안된 IKE SA 채널을 통해 전송되므로 수동 스니퍼에게 신원이 밝혀지지 않습니다. 또한 이 단계에서 양쪽은 2단계에서 IPsec SA가 사용할 IPsec 암호화 및 인증 알고리즘을 협상합니다.

### IKE 2단계

IKE 2단계에서, 양쪽은 **각 방향에 하나씩** SA를 생성합니다.

2단계가 끝나면, 양쪽의 두 SA에 대한 암호화 및 인증 세션 키가 설정됩니다.
그러면 양쪽은 8.7.3절과 8.7.4절에서 설명한 대로 SA를 사용하여 보안된 데이터그램을 보낼 수 있습니다.

### 두 단계를 사용하는 이유

IKE에서 두 단계를 사용하는 주된 동기는 **계산 비용**입니다.
두 번째 단계는 공개키 암호화를 포함하지 않으므로, IKE는 두 IPsec 엔티티 사이에 상대적으로 적은 계산 비용으로 **많은 수의 SA**를 생성할 수 있습니다.
