# 3.6 혼잡 제어의 원리 (Principles of Congestion Control)

이전 절에서는 신뢰성 있는 데이터 전송 서비스를 제공하기 위해 TCP가 사용하는 일반 원리와 구체적인 메커니즘을 살펴보았습니다.  
실제로는 네트워크 혼잡이 발생하면서 라우터 버퍼가 넘쳐 패킷 손실이 일어나는 경우가 많습니다.  
패킷 재전송은 이러한 손실(즉, 특정 전송 계층 세그먼트의 손실)을 해결하지만, 근본적인 혼잡의 원인 — 너무 많은 송신자가 과도한 속도로 데이터를 보내려는 문제는 해결하지 못합니다.   
따라서 네트워크 혼잡을 해결하기 위해서는 송신 속도를 조절할 메커니즘이 필요합니다.

이 절에서는 왜 혼잡이 문제가 되는지, 혼잡이 상위 계층 애플리케이션의 성능에 어떤 영향을 주는지, 그리고 이를 피하거나 대응하기 위한 다양한 접근법을 논의합니다.  
이러한 일반적인 혼잡 제어의 이해는 네트워킹의 가장 중요한 주제 중 하나로, TCP 혼잡 제어 알고리즘의 이해를 위한 기초가 됩니다.

## 3.6.1 혼잡의 원인과 비용 (The Causes and the Costs of Congestion)

혼잡 제어를 이해하기 위해 점점 복잡해지는 세 가지 시나리오를 살펴보겠습니다. 각각의 경우에서 왜 혼잡이 발생하는지, 그리고 혼잡이 가져오는 비용(리소스 낭비, 성능 저하 등)을 분석합니다.

### 시나리오 1: 두 송신자와 무한 버퍼를 가진 라우터 (Two Senders, a Router with Infinite Buffers)

가장 단순한 혼잡 상황을 가정합니다. 두 호스트 A와 B가 동일한 링크를 공유하는 경우입니다.
- 각 호스트는 λ_in의 비율로 데이터를 전송합니다.
- 라우터는 무한한 버퍼를 가지고 있어 패킷 손실은 발생하지 않습니다.

**결과:**
- 송신률이 R/2 이하일 때, 수신자는 송신자와 동일한 속도로 데이터를 받습니다.
- 송신률이 R/2를 초과하면, 각 호스트의 처리량(throughput)은 R/2로 제한됩니다.

이 상황에서 링크는 최대 용량으로 동작하지만, 지연(delay)은 무한히 증가합니다.  
즉, **처리량은 높지만 지연이 극단적으로 커지는 것이 첫 번째 혼잡 비용**입니다.

> **요약:** 링크가 가득 차면 패킷은 버퍼에 쌓이고, 결국 대기 시간이 폭증합니다. 이는 혼잡으로 인한 첫 번째 성능 저하입니다.

### 시나리오 2: 두 송신자와 유한 버퍼를 가진 라우터 (Two Senders and a Router with Finite Buffers)

이번에는 라우터 버퍼가 유한한 경우를 가정합니다.
- 버퍼가 가득 차면 새로 들어오는 패킷은 버려집니다(drop).
- 각 송신자는 신뢰성 있는 전송을 위해 손실된 패킷을 재전송합니다.

여기서 송신률과 **제공 부하(Offered Load)** λ'_in 을 구분해야 합니다.  
λ_in은 원래 데이터 송신 속도이고, λ'_in은 재전송을 포함한 실제 네트워크 부하입니다.

**세 가지 경우:**
1. **이상적인 경우** – 송신자가 버퍼 상태를 정확히 알고 있을 때  
   → 손실 없음, 처리량 = λ_in (단, R/2 이하).

2. **현실적인 경우** – 손실이 확인된 후에만 재전송  
   → 일부 재전송 발생. 예를 들어 λ'_in = R/2일 때 실제 수신 속도는 R/3 정도.  
   → **두 번째 혼잡 비용:** 손실된 패킷을 보상하기 위한 재전송으로 인한 불필요한 트래픽.

3. **비효율적 재전송의 경우** – 패킷이 단순히 지연되었는데도 송신자가 일찍 재전송  
   → 동일한 패킷이 두 번 전송되어 라우터의 대역폭이 낭비됩니다.  
   → **세 번째 혼잡 비용:** 불필요한 재전송으로 인한 네트워크 자원 낭비.

> **요약:** 패킷 손실이 발생하면 재전송으로 인해 네트워크 부하가 늘어나고, 불필요한 복제 트래픽이 전송되어 혼잡을 악화시킵니다.

### 시나리오 3: 네 송신자, 유한 버퍼, 다중 홉 경로 (Four Senders, Routers with Finite Buffers, and Multihop Paths)

마지막 시나리오에서는 4개의 호스트가 서로 겹치는 2홉 경로를 통해 데이터를 전송합니다.  
예: A→C는 R1과 R2를 거치고, B→D는 R2를 공유합니다.

- **트래픽이 적을 때:** 버퍼 오버플로가 거의 없고, 처리량은 입력 부하 λ_in에 비례.
- **트래픽이 많을 때:** R2에서 두 연결이 경쟁하게 되며, 한쪽의 부하가 커질수록 다른 쪽의 처리량은 줄어듭니다.  
  결국 B-D의 부하가 매우 커지면, A-C의 처리량은 0에 수렴하게 됩니다.

이때 발생하는 중요한 문제는 **낭비된 네트워크 작업량(wasted work)**입니다.
- 예를 들어, 첫 번째 라우터 R1이 패킷을 R2로 전달했는데, R2에서 그 패킷이 버려진다면  
  R1이 그 패킷을 전송하는 데 쓴 자원은 모두 낭비가 됩니다.
- 즉, **혼잡으로 인해 하류(Downstream)에서 폐기된 패킷은 상류(Upstream)의 전송 용량까지 낭비**하게 됩니다.

> **네 번째 혼잡 비용:** 경로 중간에서 버려진 패킷이 상위 홉의 전송 용량까지 무의미하게 소모시킴.

## 3.6.2 혼잡 제어 방식 (Approaches to Congestion Control)

이번 절에서는 실제 네트워크에서 사용되는 두 가지 일반적인 혼잡 제어 접근법을 살펴보고,  
이를 구현한 구체적인 네트워크 구조와 프로토콜을 함께 논의합니다.

혼잡 제어는 크게 **네트워크 계층이 전송 계층에 명시적인 도움을 주는가 여부**에 따라  
두 가지 방식으로 나눌 수 있습니다.

### 1. 종단 간 혼잡 제어 (End-to-End Congestion Control)

이 접근법에서는 **네트워크 계층이 전송 계층에 아무런 직접적인 지원을 제공하지 않습니다.**  
즉, 혼잡이 발생했는지는 오로지 **송신자와 수신자가 관찰한 네트워크의 동작 결과**  
예를 들어 **패킷 손실이나 지연 증가**를 통해 **추론(infer)** 해야 합니다.

TCP는 이러한 **종단 간 혼잡 제어 방식**을 채택합니다.  
IP 계층이 혼잡 상태에 대한 피드백을 제공하지 않기 때문입니다.

- TCP는 세그먼트 손실(예: 타임아웃 발생 또는 3중 중복 ACK 수신)을 혼잡의 신호로 간주합니다.
- 혼잡이 감지되면 TCP는 혼잡 윈도우 크기를 줄여 송신 속도를 낮춥니다.
- 최근에는 **RTT(왕복 지연 시간)의 증가를 혼잡의 지표로 활용하는 방식**도 제안되었습니다.

> **핵심 요약:** TCP는 네트워크로부터 직접적인 신호를 받지 않고,  
> 패킷 손실과 지연을 관찰해 스스로 혼잡을 감지하고 송신 속도를 조절합니다.

### 2. 네트워크 지원 혼잡 제어 (Network-Assisted Congestion Control)

이 방식에서는 **라우터가 송신자나 수신자에게 네트워크의 혼잡 상태를 직접 알려줍니다.**  
피드백의 형태는 다양하며, 단순히 “링크가 혼잡하다”는 한 비트 신호일 수도 있고,  
보다 정교한 방식으로 **송신 가능한 최대 전송 속도**를 알려줄 수도 있습니다.

예를 들어,
- **ATM ABR(Available Bit Rate)** 방식에서는 라우터가 송신자에게  
  자신이 지원할 수 있는 최대 전송률을 알려줍니다.
- 초기 네트워크 구조인 **IBM SNA, DECnet, ATM 네트워크** 등이  
  이런 **네트워크 지원형 혼잡 제어**를 구현했습니다.

반면, **인터넷 표준(IP, TCP)** 은 기본적으로 **종단 간 제어 방식**을 사용하지만,  
최근에는 일부 상황에서 선택적으로 네트워크 지원 혼잡 제어를 사용할 수도 있습니다.

### 네트워크 지원 혼잡 제어의 구현 방식

라우터가 송신자에게 혼잡 정보를 전달하는 방법은 두 가지가 있습니다.

1. **직접 피드백(Direct Feedback)**
    - 라우터가 송신자에게 **혼잡 알림 패킷(Choke Packet)** 을 직접 보냅니다.
    - 예를 들어 “지금 혼잡 상태입니다!”라는 메시지를 보냅니다.

2. **패킷 마킹 기반 피드백(Marked Packet Feedback)**
    - 라우터가 송신자에서 수신자로 가는 패킷의 헤더 일부를 수정(mark)하여 혼잡을 표시합니다.
    - 수신자는 이 마크를 확인한 뒤, 다시 송신자에게 혼잡 정보를 알려줍니다.
    - 이 방식은 전체 왕복 시간(RTT)을 필요로 합니다.

> **핵심 요약:** 네트워크 지원 혼잡 제어는 라우터가 혼잡 상태를 직접 알리는 구조이며,  
> 단순 알림부터 전송률 조정까지 다양한 형태의 피드백을 제공합니다.

| 구분 | 방식 | 혼잡 인식 방법 | 예시 프로토콜 |
|------|------|----------------|----------------|
| 종단 간 (End-to-End) | 송신자/수신자가 네트워크 상태를 추론 | 패킷 손실, 지연 증가 | TCP |
| 네트워크 지원 (Network-Assisted) | 라우터가 직접 혼잡 상태를 알림 | 혼잡 알림 비트, 마킹, 전송률 통보 | ATM ABR, DECnet, SNA 등 |


