# 1.4 패킷 교환 네트워크에서의 지연, 손실과 처리율

인터넷은 사용자들이 여러 단말 장치에 분산된 응용 서비스를 이용할 수 있도록 하는 기반 시설로 볼 수 있습니다. <br>
이상적으로는, 우리가 보내고자 하는 모든 데이터를 **순간적으로** 목적지 단말에 전송하고, **아무런 데이터 손실 없이** 전달되기를 바랍니다. <br>
하지만 이런 요구는 현실적으로 불가능합니다. 실제로 컴퓨터 네트워크의 처리량(throughput, 즉 초당 전송 가능한 데이터의 최대량)은 제한되어 있고, 패킷을 전달할 때 반드시 지연이 발생하며, 패킷 손실도 발생합니다. <br>
한편, 이러한 지연, 손실, 처리량의 한계는 물리적 법칙에 의해 결정되며, 이런 문제들이 있기 때문에 우리가 해결해야 할 흥미로운 주제들이 많아집니다. <br>
이 절에서는 컴퓨터 네트워크에서의 지연, 손실, 그리고 처리량에 대해 탐구하고 정량적으로 분석합니다.

## 1.4.1 패킷 교환 네트워크에서의 지연 개요

네트워크에서 하나의 패킷은 어떤 호스트(source)에서 시작하여 여러 라우터를 거쳐 최종 목적지(destination)에 도달합니다. <br>
패킷이 각 노드(호스트 또는 라우터)를 통과할 때마다 다양한 지연이 발생할 수 있습니다. <br>
주요 지연에는 **노드 처리 지연(nodal processing delay)**, **큐잉 지연(queuing delay)**, **전송 지연(transmission delay)**, 그리고 **전파 지연(propagation delay)** 가 있습니다. <br>
이 지연들을 모두 합하면 **총 노드 지연(total nodal delay)** 이 됩니다. 검색 엔진, 웹 브라우징, 이메일, 지도, 실시간 메시지, 음성 통화 등 네트워크 기반 응용프로그램의 성능은 이러한 지연에 크게 영향을 받습니다. <br>
패킷 교환과 컴퓨터 네트워크를 더 깊이 이해하기 위해서는 이 지연들의 특성과 중요성을 파악해야 합니다.

### 지연의 종류

아래 그림은 앞서 언급한 여러 지연의 유형을 보여줍니다. <br>
이 그림은 한 패킷이 한 컴퓨터에서 다른 컴퓨터로 이동하는 경로 중 일부를 나타내며, 패킷이 한 컴퓨터에서 A 라우터로 전송되어 B 라우터로 이동하는 상황을 보여줍니다. <br>
우리의 목표는 A 라우터에서 발생하는 노드 지연이 어떤 요소에 의해 결정되는지 분석하는 것입니다. A 라우터에는 B 라우터로 연결되는 선로가 있으며, 출구에 버퍼 큐가 있습니다. <br>
패킷이 상위 노드에서 A에 도착하면, A 라우터는 패킷의 헤더를 분석하여 어떤 선로를 통해 전송할지 결정합니다. 이 예에서는 B로 가는 선로입니다. <br>
해당 선로가 다른 패킷을 전송 중이 아니고, 버퍼 큐에 대기 중인 패킷이 없을 때만 패킷을 전송할 수 있으며, 그렇지 않으면 큐에 대기해야 합니다.

<img width="723" height="310" alt="Image" src="https://github.com/user-attachments/assets/2cfbad79-9bde-40b0-aa1b-1226e9850170" />

#### 처리 지연(Processing Delay)

- **처리 지연**은 "패킷의 헤더를 분석하여 어떤 선로로 전송할지 결정하는 데 걸리는 시간"을 의미합니다.
- 오류 검사(패킷이 전송 중 비트 단위 오류가 발생했는지 확인)와 같은 추가 작업도 포함됩니다.
- 고속 라우터에서는 처리 지연이 대체로 마이크로초 수준, 혹은 그 이하입니다.
- 노드 처리 후 라우터는 패킷을 전송할 선로의 버퍼 큐에 넣습니다(라우터 동작에 대한 자세한 내용은 4장에서 다룹니다).

#### 큐잉 지연(Queuing Delay)

- 패킷이 큐에 대기하면 **큐잉(대기) 지연**이 발생합니다.
- 대기 시간은 큐에 앞서 대기 중인 패킷 수에 따라 달라집니다.
    - 큐가 비어 있고, 해당 선로가 다른 패킷을 전송 중이 아니라면 대기 지연은 0입니다.
    - 현재 트래픽이 많아 큐에 많은 패킷이 대기 중이라면 대기 지연이 매우 길어집니다.
    - 대기 중인 패킷 수는 해당 큐로 유입되는 트래픽의 밀도와 특성에 따라 달라집니다.
- 실제로 대기 지연은 몇 마이크로초에서 몇 밀리초까지 다양합니다.

#### 전송 지연(Transmission Delay)

- 패킷 교환 네트워크에서는 패킷이 FIFO 원칙에 따라 전송되며, 패킷이 라우터 A에 완전히 도착한 후에야 전송할 수 있습니다.
- 패킷 길이가 L 비트이고, A에서 B로의 선로 속도가 R bps라면, **전송 지연**은 L/R 초가 됩니다. 즉, 패킷 전체를 A에서 B로 전송하는 데 걸리는 시간입니다.
- 실제로 전송 지연은 몇 마이크로초에서 몇 밀리초까지 다양합니다.

#### 전파 지연(Propagation Delay)

- 각 비트가 선로에 실린 후, B 라우터까지 전파되는 시간이 **전파 지연**입니다.
- 전파 시간은 물리적 매체(광섬유, 구리선, 무선 등)의 전파 속도에 따라 달라지며, 초당 2×미터에서 미터까지, 즉 광속에 근접하거나 그 이하입니다.
- 전파 지연은 d/s로 나타내며, d는 두 라우터 사이의 거리, s는 선로의 전파 속도입니다.
- 패킷의 마지막 비트가 B에 도달하면, 모든 비트가 B 라우터에 저장됩니다. 이후 B 라우터가 앞서 설명한 과정을 반복합니다.
- 광역 네트워크에서는 전파 지연이 대체로 밀리초 수준입니다.

### 전송 지연과 전파 지연 비교

컴퓨터 네트워크를 처음 배우는 사람들은 종종 전송 지연과 전파 지연을 혼동합니다. 둘의 차이는 미묘하지만 매우 중요합니다.

| - | 전송 지연 | 전파 지연 |
| --- | --- | --- |
| **정의** | 패킷 전체를 선로에 올리는 데 걸리는 시간 | 한 비트를 한 라우터에서 다른 라우터로 전파하는 데 걸리는 시간 |
| **공식** | 패킷 크기 / 선로 전송 속도 | 선로 길이 / 선로 전파 속도 |
| **비고** | 라우터 간 거리와 무관 | 패킷 크기나 전송 속도와 무관 |

"고속도로의 차량 행렬" 비유로 이 두 지연을 설명할 수 있습니다.

- 예시:
    - 고속도로에 100km마다 톨게이트가 있음
    - 모든 차량은 100km/h로 주행(톨게이트를 빠져나가자마자 바로 100km/h로 가속)
    - 10대 차량이 한 대씩 줄지어 주행
    - 톨게이트에서 차량 한 대를 처리하는 데 12초 소요
    - 한밤중이라 이 차량 행렬 외에는 차량 없음
    - 첫 차량이 톨게이트에 들어가면, 나머지 9대가 모두 처리될 때까지 기다렸다가 함께 출발
- 비유:
    - 톨게이트: 라우터
    - 톨게이트 사이 도로: 선로
    - 차량: 비트
    - 차량 행렬: 패킷
    - 차량 속도: 전파 속도
    - 톨게이트 처리 시간: 전송 속도
    - 차량 행렬이 함께 출발: 패킷 교환
- 지연 계산:
    - 톨게이트에서 10대 차량을 모두 처리하는 시간은 (10대)/(5대/분)=2분 → 전송 지연에 해당
    - 차량 한 대가 톨게이트에서 다음 톨게이트까지 이동하는 시간은 (100km)/(100km/h)=1시간 → 전파 지연에 해당
    - 차량 행렬의 한 대가 톨게이트를 떠나서 다음 톨게이트에 도착할 때까지의 총 지연은 62분
- 만약 톨게이트 처리 시간이 차량 이동 시간보다 길다면? 예를 들어, 차량이 1000km/h로 이동하고, 톨게이트에서 한 대 처리에 1분 소요:
    - 도로 이동 시간: (100km)/(1000km/h)=6분
    - 톨게이트에서 10대 처리: (10대)/(1대/분)=10분
    - 앞 차량 몇 대는 이미 다음 톨게이트에 도착했지만, 뒤 차량은 아직 현재 톨게이트에서 대기하는 현상 발생 → 실제 패킷 교환 네트워크와 유사

## 1.4.2 큐잉 지연과 패킷 손실

총 노드 지연 중 가장 복잡하고 흥미로운 요소는 큐잉 지연입니다. <br>
다른 세 가지 지연과 달리, 각 패킷이 겪는 큐잉 지연은 매우 다릅니다. <br>
예를 들어, 10개의 패킷이 동시에 버퍼 큐에 도착하면, 첫 번째 패킷은 바로 전송되어 대기 지연이 없지만, 마지막 패킷은 앞선 9개가 모두 전송된 뒤에야 전송되므로 대기 지연이 매우 큽니다. <br>
따라서 큐잉 지연을 설명할 때는 평균 큐잉 지연, 분산, 특정 값을 초과할 확률 등 통계적 특성을 사용합니다.

큐잉 지연이 클 때와 무시할 수 있을 때는 언제일까요? 이는 **패킷 유입 속도**, **선로 전송 속도**, 그리고 **트래픽 유형**(패킷이 일정 간격으로 규칙적으로 오는지, 한 번에 몰려오는지 등)에 따라 달라집니다. 좀 더 정확히 설명하기 위해 다음과 같이 정의합니다:

- 평균 패킷 도착 속도: a(초당 a개 패킷)
- 선로 전송 속도: R(초당 R비트 전송)
- 모든 패킷이 L비트라면, 평균 도착 속도는 La(초당 La비트)
- 큐 길이는 매우 커서 무한히 많은 비트를 저장할 수 있다고 가정

이때 **트래픽 강도(Traffic Intensity)** 는 평균 도착 속도와 전송 속도의 비율, 즉 La/R(단위 없음)으로 정의합니다. 트래픽 강도는 큐잉 지연을 추정하는 데 중요한 지표입니다.

- La/R > 1이면, 평균 도착 속도가 전송 속도를 초과하므로, 패킷 대기열이 무한히 늘어나고, 큐잉 지연도 무한대로 커집니다! 그래서 시스템 설계에서는 트래픽 강도가 항상 1을 넘지 않도록 해야 합니다.
- La/R ≤ 1이면, 트래픽 유형이 큐잉 지연에 주요 영향을 미칩니다.

하지만 위 두 예시는 너무 이상적이며, 실제로는 패킷이 **랜덤하게 도착**합니다. 즉, 인접한 두 패킷 사이의 간격이 불규칙합니다. 이런 현실적 상황에서는 La/R만으로 큐잉 지연의 통계적 특성을 완전히 설명할 수 없습니다. 그래도 La/R의 크기로 대략적인 지연 정도를 직관적으로 파악할 수 있습니다.

- 트래픽 강도가 0에 가까우면, 패킷이 거의 오지 않고, 패킷 사이 간격이 커서 대기 지연이 거의 없습니다.
- 트래픽 강도가 1에 가까우면, 평균 도착 속도가 전송 속도를 일시적으로 초과하는 구간이 생기고, 그 기간 동안 패킷이 대기열에 쌓입니다. 이후 도착 속도가 낮아지면 대기열이 줄어듭니다.

트래픽 강도가 1에 가까워질수록 평균 대기열 길이가 급격히 늘어납니다. 평균 큐잉 지연과 트래픽 강도의 관계를 그래프로 나타내면 다음과 같습니다:
이 그래프의 중요한 정보는 트래픽 강도가 1에 가까워질 때 평균 큐잉 지연이 매우 빠르게 증가한다는 점입니다. 트래픽이 조금만 늘어나도 지연이 급격히 증가합니다. <br>
고속도로에서 평소에도 정체가 심한 구간(트래픽 강도가 1에 근접한 구간)에 연휴 등으로 차량이 조금만 더 늘어나도 평균 속도가 급격히 느려지는 경험을 해본 적이 있을 것입니다.

### 패킷 손실(Packet Loss)

지금까지는 "큐 길이가 매우 길어서 무한히 많은 비트를 저장할 수 있다"는 가정 하에 큐잉 지연을 논의했습니다. <br>
하지만 실제로는 버퍼 큐의 길이가 제한되어 있으며, 크기는 라우터의 설계와 가격에 따라 달라집니다. <br>
큐 용량이 제한되어 있으므로, 큐잉 지연이 무한대로 늘어나는 일은 없습니다. 대신 트래픽 강도가 특정 수준을 넘으면, 대기열이 꽉 차서 새로 도착한 패킷이 큐에 들어가지 못하고, 라우터가 해당 패킷을 **버리게** 됩니다. 이것이 **패킷 손실(Packet Loss)** 입니다.

단말 장치 입장에서는 "패킷이 네트워크에 들어갔지만 목적지에 도달하지 못한" 상태가 바로 패킷 손실입니다. 트래픽 강도가 증가할수록 패킷 손실 비율도 높아집니다. <br>
따라서 노드의 성능을 평가할 때 지연뿐 아니라 손실률도 함께 고려합니다. 종단 간(end-to-end)에서 손실된 패킷은 재전송되어 모든 데이터가 결국 목적지에 도달하도록 보장합니다.

## 1.4.3 종단 간 지연(End-to-End Delay)

### Traceroute

"종단 간 지연"을 직접 체험하려면 Traceroute 프로그램을 사용해볼 수 있습니다. <br>
Traceroute는 모든 컴퓨터에서 실행 가능하며, 사용자가 목적지 호스트명을 지정하면 해당 호스트로 특별한 패킷을 여러 개 전송합니다. <br>
이 패킷들은 목적지로 가는 경로상의 여러 라우터를 거치며, 각 라우터는 해당 패킷을 받으면 출발지로 간단한 메시지(라우터의 이름과 주소 포함)를 회신합니다.

좀 더 정확히 말하면, 출발지와 목적지 사이에 N-1개의 라우터가 있다면, 출발지는 N개의 특별한 패킷을 목적지로 보냅니다. <br>
각 패킷은 번호가 매겨져 있으며, 첫 번째는 1, 마지막은 N입니다. n번째 라우터가 n번째 패킷을 받으면, 해당 패킷을 계속 전송하지 않고 출발지에 메시지를 회신합니다. <br>
목적지 호스트가 N번째 패킷을 받으면 역시 회신합니다. 출발지는 패킷을 보낸 시점과 회신 메시지를 받은 시점의 시간차, 그리고 메시지를 보낸 라우터(또는 목적지)의 주소와 이름을 기록합니다. <br>
이를 통해 출발지는 목적지까지의 경로와 각 라우터까지의 왕복 시간을 재구성할 수 있습니다. Traceroute는 위 과정을 세 번 반복하므로 실제로는 3×N 개의 패킷을 목적지로 전송합니다.

다음은 Traceroute 출력 예시입니다. 출발지는 `gaia.cs.umass.edu`(University of Massachusetts의 한 컴퓨터)이고, 목적지는 `cis.poly.edu`(Polytechnic University in Brooklyn의 한 컴퓨터)입니다. <br>
각 행에는 패킷 번호 n, 라우터 이름, 라우터 주소(IPv4 또는 IPv6), 그리고 세 번의 실험에서 측정된 시간차가 나옵니다. 만약 출발지가 어떤 라우터로부터 회신 메시지를 세 번 모두 받지 못하면(손실 발생), 해당 행에 별표(*)가 표시되어 회신 횟수가 부족함을 알립니다.

```
1 cs-gw (128.119.240.254) 1.009 ms 0.899 ms 0.993 ms
2 128.119.3.154 (128.119.3.154) 0.931 ms 0.441 ms 0.651 ms
3 -border4-rt-gi-1-3.gw.umass.edu (128.119.2.194) 1.032 ms 0.484 ms 0.451 ms
4 -acr1-ge-2-1-0.Boston.cw.net (208.172.51.129) 10.006 ms 8.150 ms 8.460 ms
5 -agr4-loopback.NewYork.cw.net (206.24.194.104) 12.272 ms 14.344 ms 13.267 ms
6 -acr2-loopback.NewYork.cw.net (206.24.194.62) 13.225 ms 12.292 ms 12.148 ms
7 -pos10-2.core2.NewYork1.Level3.net (209.244.160.133) 12.218 ms 11.823 ms 11.793 ms
8 -gige9-1-52.hsipaccess1.NewYork1.Level3.net (64.159.17.39) 13.081 ms 11.556 ms 13.297 ms
9 -p0-0.polyu.bbnplanet.net (4.25.109.122) 12.716 ms 13.052 ms 12.786 ms
10 cis.poly.edu (128.238.32.126) 14.080 ms 13.035 ms 12.802 ms
```

이 경로에는 출발지와 목적지 사이에 9개의 라우터가 있습니다. 대부분의 라우터가 이름을 갖고 있으며, 모든 라우터는 고유한 주소를 갖고 있습니다. <br>
예를 들어, 세 번째 라우터의 이름은 `border4-rt-gi-1-3.gw.umass.edu`이고, 주소는 `128.119.2.194`입니다. <br>
이 라우터에서 첫 번째 왕복 시간은 1.03ms, 두 번째와 세 번째는 각각 0.48ms, 0.45ms입니다. 이 왕복 시간에는 앞서 설명한 모든 지연(전송, 전파, 노드 처리, 큐잉 지연)이 포함됩니다. <br>
큐잉 지연은 변동이 심해, 작은 번호의 패킷이 더 큰 번호의 패킷보다 더 긴 왕복 시간을 가질 수도 있습니다. 위 예시에서 6번째 라우터의 지연이 7번째보다 큽니다!

### 종단 시스템, 응용, 기타 지연

노드 처리 지연, 전송 지연, 큐잉 지연 외에도, 단말 시스템 내에서 추가적인 전송 지연이 발생할 수 있습니다. <br>
예를 들어, 일부 단말 시스템은 패킷을 공유 매체(Wi-Fi, 케이블 모뎀 등)로 전송할 때 의도적으로 지연을 추가하기도 합니다. <br>
이런 전송 프로토콜은 여러 단말이 전송 매체를 공유하기 위해 설계된 것입니다. 6장에서 이러한 프로토콜을 자세히 다룹니다. <br>
또 하나 중요한 지연 유형은 media packetization delay로, 실시간 음성 통화 시스템에서 흔히 발생합니다. <br>
음성 통화 시스템에서는 송신자가 패킷에 인코딩된 디지털 음성 신호를 채운 후 전송합니다. 패킷을 채우는 데 걸리는 시간, 즉 packetization delay는 사용자가 느끼는 통화 품질에 큰 영향을 미칩니다.

## 1.4.4 컴퓨터 네트워크에서의 처리량(Throughput)

지연과 손실 외에도, 네트워크 성능을 평가하는 데 중요한 또 다른 지표가 **종단 간 처리량(end-to-end throughput)** 입니다. 처리량에는 두 가지가 있습니다. 예를 들어, 호스트 A가 큰 파일(예: 동영상)을 호스트 B로 전송한다고 가정하면,

- **순간 처리량(Instantaneous throughput)** 은 특정 순간에 B가 받은 데이터량(bits/sec)을 의미하며, 순간 속도와 비슷합니다. 많은 P2P 다운로드 소프트웨어가 이 값을 표시합니다(다운로드 속도).
- **평균 처리량(Average throughput)** 은 파일 크기와 전체 전송 시간의 비율로, 평균 속도와 비슷합니다. 파일 크기가 F비트이고, B가 전체 파일을 받는 데 T초가 걸렸다면, 평균 처리량은 F/T bits/sec입니다.

<img width="753" height="407" alt="Image" src="https://github.com/user-attachments/assets/acbca9c8-3da0-4fc1-a5b4-7faa514e98a0" /> <br>
<img width="764" height="658" alt="Image" src="https://github.com/user-attachments/assets/68af4ad9-b3e9-4456-a42b-919be026d09c" />

일부 응용프로그램에서는 낮은 지연과 안정적인 순간 처리량이 중요합니다(예: 인터넷 전화는 순간 처리량이 24kbps 정도 유지되어야 하고, 영상통화는 256kbps 이상 필요). 반면, 파일 전송 소프트웨어처럼 평균 처리량이 더 중요한 경우도 있습니다.

